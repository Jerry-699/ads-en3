<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lifeinvader Ads — EN-03 (Auto-Detect + Manual Fix)</title>
<style>
  :root{
    --bg:#0e1320; --card:#151b2d; --text:#e8eefc; --muted:#9fb0d3; --accent:#6aa0ff; --ok:#22c55e; --warn:#ffb020; --bad:#ef4444; --chip:#202945;
    --shadow: 0 10px 30px rgba(10,14,25,.4);
  }
  html.light{
    --bg:#f4f6fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#2563eb; --ok:#16a34a; --warn:#b7791f; --bad:#dc2626; --chip:#eef2ff;
    --shadow: 0 10px 24px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:28px 18px 8px;display:flex;gap:12px;align-items:center;justify-content:space-between;position:sticky;top:0;background:linear-gradient(180deg,var(--bg) 80%,transparent);z-index:10}
  .brand{font-weight:900;font-size:26px;letter-spacing:.3px}
  .hint{color:var(--muted);font-size:13px}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px 16px}
  textarea,input,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid transparent;background:var(--chip);color:var(--text);outline:none}
  textarea{min-height:140px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  .btn{all:unset;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1.5px solid var(--accent)}
  .btn.warn{background:var(--warn);color:#111}
  .btn.bad{background:var(--bad)}
  .btn.ok{background:var(--ok)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:13px}
  .out{font-family:ui-monospace,SFMono-Regular,Consolas,monospace;padding:12px 14px;border-radius:10px;background:#0a0f1a22;border:1px dashed #7aa2ff55}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .badge{padding:3px 8px;border-radius:999px;font-size:12px;background:#1f2937;color:#cbd5e1}
  .badge.ok{background:#052e1a;color:#a7f3d0}
  .badge.warn{background:#3a2300;color:#fde68a}
  .badge.bad{background:#3f0b0b;color:#fecaca}
  .sectionTitle{font-weight:800;margin:8px 0 4px}
  .muted{color:var(--muted)}
  .toggle{display:inline-flex;gap:8px;align-items:center;cursor:pointer;user-select:none}
  .switch{inline-size:46px;block-size:26px;background:#334155;border-radius:999px;position:relative}
  .knob{position:absolute;inset:3px;inline-size:20px;block-size:20px;background:#fff;border-radius:50%;transition:transform .2s}
  html.light .knob{transform:translateX(20px)}
  .footer{opacity:.7;margin:30px 0 60px;text-align:center;font-size:13px}
  @media (max-width:860px){
    .row,.row3{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header class="wrap">
  <div>
    <div class="brand">Lifeinvader Ads — EN-03</div>
    <div class="hint">Policy-accurate ad builder with <b>Auto-Detect</b> raw-ad parser + Manual Fix & Learning.</div>
  </div>
  <label class="toggle">
    <span class="hint">Day / Night</span>
    <span class="switch"><span class="knob"></span></span>
  </label>
</header>

<main class="wrap">
  <!-- RAW AD -->
  <section class="card" id="rawCard">
    <div class="sectionTitle">⚡ Auto-Detect (Raw Ad) + Manual Fix</div>
    <div class="hint" style="margin-bottom:8px">
      Paste any raw text. The parser auto-detects <b>category</b>, <b>action</b>, and <b>money label</b>, fixes money formats (<i>20k → $20.000</i>, <i>1.5m → $1.5 Million</i>), maps <i>level 1–4</i> → <i>low/medium/high/max quality</i>,
      applies Real Estate / Auto feature order, blocks blacklisted terms, and outputs a policy-perfect ad.
    </div>
    <textarea id="raw" placeholder="e.g., selling house no 85 garden 5 gs insurance • buyyingng a Ruby • Renting out house 1023 rent 100k / week • selling level 4 engine • price 20k …"></textarea>

    <div class="toolbar" style="margin-top:10px">
      <button class="btn" id="generateBtn">Generate</button>
      <button class="btn ghost" id="clearBtn">Clear</button>
      <span class="hint">k/m shorthands: <b>20k → $20.000</b>, <b>1.5k → $1.500</b>, <b>50m → $50 Million</b>.</span>
    </div>

    <!-- OUTPUT -->
    <div style="margin-top:16px">
      <div class="sectionTitle">Formatted Output</div>
      <div class="row">
        <input id="output" class="out" readonly placeholder="Your formatted ad will appear here…" />
        <div class="toolbar" style="align-items:center">
          <button class="btn ok" id="copyBtn">Copy</button>
          <span id="detectChips" class="chips"></span>
        </div>
      </div>
    </div>

    <!-- MANUAL FIX (AUTO-FILLED) -->
    <div class="sectionTitle" style="margin-top:18px">Manual Fix (optional)</div>
    <div class="row3">
      <div>
        <div class="muted">Opener</div>
        <select id="mfOpener">
          <option>Auto (detected)</option>
          <option>Buying</option>
          <option>Selling</option>
          <option>Trading</option>
          <option>Selling or trading</option>
          <option>Renting out</option>
          <option>Renting</option>
          <option>Looking for</option>
        </select>
      </div>
      <div>
        <div class="muted">Subject (edit main sentence)</div>
        <input id="mfSubject" placeholder='e.g., house №85 with a garden, 5 g.s. and insurance' />
      </div>
      <div>
        <div class="muted">Amount</div>
        <input id="mfAmount" placeholder='e.g., 20k, 1.7k each, 5m, Negotiable' />
      </div>
    </div>
    <div class="row3" style="margin-top:10px">
      <div>
        <div class="muted">Money label</div>
        <select id="mfLabel">
          <option>Auto (detected)</option>
          <option>Price:</option>
          <option>Budget:</option>
          <option>Rent:</option>
        </select>
      </div>
      <div>
        <div class="muted">Detected category (read-only)</div>
        <input id="mfCat" readonly placeholder="Auto / Real Estate / Business / Dating / Work / Other" />
      </div>
      <div style="display:flex;gap:10px;align-items:end">
        <button class="btn" id="applyBtn">Apply</button>
        <button class="btn ok" id="applySaveBtn">Apply & Save</button>
      </div>
    </div>

    <!-- LEARNING -->
    <div class="card" style="margin-top:14px;background:transparent;border:1px dashed #6aa0ff55">
      <div class="row">
        <div class="muted">Learning rules</div>
        <label class="toggle" style="justify-self:end">
          <span class="hint">Auto-apply rules</span>
          <span class="switch"><span class="knob"></span></span>
          <input id="autoApply" type="checkbox" hidden>
        </label>
      </div>
      <div id="ruleInfo" class="hint">No rules saved yet.</div>
    </div>
  </section>

  <p class="footer">Built for EN-03 policy accuracy — opener words; Price/Budget/Rent; dot-thousands; № for numbers; Real Estate feature order; vehicles quoted with upgrade order (configuration → visual upgrades → luminous wheels → insurance → turbo kit → drift kit); blacklist; level→quality mapping.</p>
</main>

<script>
/* --------------------------- Helpers & Data --------------------------- */
const el = id => document.getElementById(id);
const $ = {
  raw: el('raw'), out: el('output'), chips: el('detectChips'),
  gen: el('generateBtn'), clear: el('clearBtn'), copy: el('copyBtn'),
  mfOpen: el('mfOpener'), mfSub: el('mfSubject'), mfAmt: el('mfAmount'),
  mfLabel: el('mfLabel'), mfCat: el('mfCat'),
  apply: el('applyBtn'), applySave: el('applySaveBtn'),
  autoApply: el('autoApply'), ruleInfo: el('ruleInfo')
};

const ACTION_WORDS = [
  'selling or trading','selling or trade','sell or trade',
  'trading','trade',
  'renting out','renting','rent out',
  'buying','looking to buy','looking to purchase','want to buy','wtb',
  'selling','for sale','wts'
];

const MONEY_LABEL = { Selling:'Price:', Buying:'Budget:', Trading:'Price:', 'Selling or trading':'Price:', 'Renting out':'Rent:', Renting:'Budget:', 'Looking for':'Budget:' };

const OFFICIAL_PLACES = [
  'Vinewood Hills','Rockford Hills','Richman','Sandy Shores','Paleto Bay','Postal','Hospital','Capitol','Fire Station','Auto Fair',
  'Bahama Mamas Bar','Tequi-la-la Bar','FIB','Hotel Spa Bar','Pacific Bluffs Country Club','Diamond Resort Bar',
  'Vanilla Unicorn Bar','Church','Stock Exchange','Stadium','Chumash','Lifeinvader','Del Perro Pier','Del Perro Beach',
  'Cayo Perico Island','Hotel','Raton Canyon','School','SAHP'
];

const BUSINESS_LIST = [
  'Ammunition Store','Bar','Car wash','Chip tuning','Clothing shop','Cowshed','Electric station','Farm','Flower shop','Freight train',
  'Gas station','Grand Elite','Hair salon','Jewelry store','Oil Well','Parking','Pet Shop','Plantation','Car sharing','State object',
  'Service station','24/7 Store','Tattoo studio','Taxi company','ATM business','Juice shop','Burger shop','Warehouse','Fight club'
];

const BLACKLIST = [
 'firearm','gun','pistol','rifle','ammunition','bulletproof','armor plate','weed','cannabis','drug','cocaine',
 'ems surgical mask','medical mask','covid mask','balaclava','scanner','radar','rope','head bag','usb with virus',
 'lock pick','crowbar','troll','animal skin','satellite dish','barricade','anti-radar','engine block','air horn',
 'grand coin','premium battlepass','playboy family','nationality','sexual','medkit','pills','tincture soup','gang hq','black market'
];

const VEHICLE_HINTS = ['car','truck','motorcycle','bike','boat','helicopter','plane','monowheel'];

const QUAL_MAP = {1:'low quality',2:'medium quality',3:'high quality',4:'max quality'};

/* --------------------------- Theme Toggle --------------------------- */
(function initTheme(){
  const apply = mode => document.documentElement.classList.toggle('light', mode==='light');
  const saved = localStorage.getItem('li-theme') || 'dark';
  apply(saved);
  document.querySelector('header .toggle').addEventListener('click', ()=>{
    const next = document.documentElement.classList.contains('light')?'dark':'light';
    localStorage.setItem('li-theme', next); apply(next);
  });
})();

/* --------------------------- Money Formatting --------------------------- */
function formatMoneyFromText(txt){
  if(!txt) return 'Negotiable';
  const t = String(txt).trim().toLowerCase();
  if (t==='negotiable' || t==='nego') return 'Negotiable';

  // capture things like "20k", "1.7k", "50m", "1.5m", "150000", "$2,000", "2.000"
  const m = t.match(/(\d+(\.\d+)?)(\s*)(k|m|million|mil)?/i);
  if(!m) return 'Negotiable';
  let n = parseFloat(m[1]);
  const unit = (m[4]||'').toLowerCase();

  // normalize by unit
  if(unit==='k') n = n*1000;
  else if(unit==='m' || unit==='million' || unit==='mil') n = n*1000000;

  // >= 1,000,000 -> "$X.Y Million"
  if(n >= 1000000){
    const millions = Math.round(n/100000)/10; // one decimal
    // keep one decimal only when needed
    const s = (Number.isInteger(millions)? millions.toFixed(0) : millions.toFixed(1));
    return `$${s} Million`;
  }

  // thousands with dot separators
  const thousands = Math.round(n);
  return '$' + thousands.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}

/* --------------------------- Detect / Normalize --------------------------- */
function hasBlacklist(raw){
  const r = raw.toLowerCase();
  return BLACKLIST.find(w=> r.includes(w));
}

function detectAction(raw){
  const r = raw.toLowerCase();
  if(/selling\s*or\s*trading|sell(?:ing)?\s*or\s*trade/.test(r)) return 'Selling or trading';
  if(/\btrading\b|\btrade\b/.test(r)) return 'Trading';
  if(/\brenting out\b|\brent out\b/.test(r)) return 'Renting out';
  if(/\brenting\b/.test(r)) return 'Renting';
  if(/\bbuying\b|\bwtb\b|\blooking to (buy|purchase)\b|\bwant to buy\b/.test(r)) return 'Buying';
  if(/\bselling\b|\bwts\b|\bfor sale\b/.test(r)) return 'Selling';
  // fallbacks from intent words
  if(/\bbudget\b/.test(r)) return 'Buying';
  if(/\bprice\b/.test(r)) return 'Selling';
  return 'Selling';
}

function detectCategory(raw){
  const r = raw.toLowerCase();
  // Hard signals
  if(/\bhouse|apartment|mansion|penthouse|casino apartment|casino penthouse|g\.s\.|w\.h\.|№|no\.?\s*\d+/.test(r)) return 'Real Estate';
  if(BUSINESS_LIST.some(b=> r.includes(b.toLowerCase())) || /\bbusiness\b|\bstate object\b|\bplantation\b/.test(r)) return 'Business';
  if(/\blooking for\b/.test(r) && /\b(poker|wife|husband|boyfriend|girlfriend|family|friends|valentine|date)\b/.test(r)) return 'Dating';
  if(/\bhiring\b|\blooking for work\b|\bjob\b|\bconstruction site\b/.test(r)) return 'Work';
  if(VEHICLE_HINTS.some(v=> r.includes(v))) return 'Auto';
  // vehicle names quoted "Brand Model"
  if(/"[^"]+"\s*(with|at|price|budget|rent|$)/i.test(raw)) return 'Auto';
  return 'Other';
}

function normalizeOpenSentence(raw, action, cat){
  let text = raw.trim();

  // map "looking to buy/purchase" → Buying; assure first word capitalization
  text = text.replace(/^\s*looking to (buy|purchase)/i,'Buying')
             .replace(/^\s*buying/i,'Buying')
             .replace(/^\s*selling or trading/i,'Selling or trading')
             .replace(/^\s*trading/i,'Trading')
             .replace(/^\s*selling/i,'Selling')
             .replace(/^\s*renting out/i,'Renting out')
             .replace(/^\s*renting/i,'Renting');

  // Level → quality (engine, transmission, suspension, tires, inventory…)
  text = text.replace(/\blevel\s*(1|2|3|4)\b/gi, (_,d)=> QUAL_MAP[+d]);

  // “no/number” → №
  text = text.replace(/\b(?:house|apartment|mansion|penthouse|casino apartment)\s*(?:no\.?|number|#)\s*(\d+)/gi,(m)=>{
    const num = m.match(/(\d+)/)[1];
    return m.replace(/(house|apartment|mansion|penthouse|casino apartment).*/i, (seg)=>{
      const name = seg.match(/house|apartment|mansion|penthouse|casino apartment/i)[0];
      return `${name} №${num}`;
    });
  });

  // Casino apartment → Casino penthouse
  text = text.replace(/casino apartment/gi,'Casino penthouse');

  // tuning/feature word maps
  text = text.replace(/\b(body upgrades|body kit)\b/gi,'visual upgrades')
             .replace(/\b(turbo)\b/gi,'turbo kit')
             .replace(/\b(drift tuning|drift assistance)\b/gi,'drift kit')
             .replace(/\b(luminous rims|unique wheels)\b/gi,'luminous wheels')
             .replace(/\b(crates|cases)\b/gi,'containers')
             .replace(/\b(spray cans|spray balloons)\b/gi,'paint cans')
             .replace(/\bextras\b/gi,'of type')
             .replace(/\bscarf\b/gi,'mask');

  // partial/full configuration
  text = text.replace(/\b(max config|max tuning|fully upgraded)\b/gi,'with full configuration')
             .replace(/\b(nearly max|partial|lvl\s*3|level 3|level 2|lvl\s*2|level 1|lvl\s*1)\b/gi,'with partial configuration');

  return text;
}

/* Real Estate features ordering */
function orderRealEstate(subject){
  // pick features
  const feats = [];
  const got = s=>subject.toLowerCase().includes(s);
  if(got('garden')) feats.push('a garden');
  const gs = subject.match(/\b(2|5|9|25)\s*g\.s\.|\b(2|5|9|25)\s*gs\b/i);
  if(gs){ const v=(gs[0].match(/\d+/)||[''])[0]; feats.push(`${v} g.s.`); }
  const wh = subject.match(/\b(3|4|5)\s*w\.h\.|\b(3|4|5)\s*wh\b/i);
  if(wh){ const v=(wh[0].match(/\d+/)||[''])[0]; feats.push(`${v} w.h.`); }
  if(got('custom interior')) feats.push('custom interior');
  if(got('insurance')) feats.push('insurance');
  if(got('helipad')) feats.push('helipad');

  // other nice features
  ['swimming pool','tennis court','long driveway','large driveway','spacious backyard','backyard'].forEach(k=>{
    if(got(k)) feats.push(k.replace('large','long').replace('backyard','spacious backyard'));
  });

  // views
  const vm = subject.match(/\b(nice|beautiful|great)\s+views?/i);
  if(vm) feats.push(vm[1] + ' views');

  // Location (capitalize if official)
  let loc = '';
  OFFICIAL_PLACES.forEach(p=>{
    if(subject.toLowerCase().includes(p.toLowerCase())) loc = p;
  });

  // Build ordered feature string
  const joined = feats.length
      ? ' with ' + feats.slice(0,-1).join(', ') + (feats.length>1?', and ':'') + feats.slice(-1) + (loc ? ' in ' + loc : '')
      : (loc ? ' in ' + loc : '');

  // Ensure “house/apartment …” base
  let base = subject;
  if(!/house|apartment|mansion|Casino penthouse/i.test(base)){
    base = 'a house' + joined;
  } else {
    // remove existing unordered features chunk heuristically:
    base = base.replace(/\swith .*$/i,'') + joined;
  }
  return base;
}

/* Subject extraction */
function extractSubject(raw, cat){
  let s = raw;

  // quoted vehicle names stay quoted
  const quoted = raw.match(/"[^"]+"/);
  if(quoted) s = quoted[0];

  // houses etc with numbers → “house №85 …”
  const prop = raw.match(/\b(house|apartment|mansion|casino (?:apartment|penthouse))\b[^.]*?(?:no\.?|number|#)?\s*(\d+)?/i);
  if(cat==='Real Estate' && prop){
    let name = prop[1].replace(/casino apartment/i,'Casino penthouse');
    const num = prop[2];
    s = num ? `${name} №${num}` : `a ${name}`;
    // add feature words from raw
    const plus = [];
    if(/\bgarden\b/i.test(raw)) plus.push('a garden');
    if(/\b(2|5|9|25)\s*g\.s?\.?/i.test(raw)) plus.push(RegExp.$1 + ' g.s.');
    if(/\b(3|4|5)\s*w\.h\.?/i.test(raw)) plus.push(RegExp.$1 + ' w.h.');
    if(/\bcustom (?:interior|furniture)\b/i.test(raw)) plus.push('custom interior');
    if(/\binsurance\b/i.test(raw)) plus.push('insurance');
    if(plus.length) s += ' with ' + plus.join(', ');
    return orderRealEstate(s);
  }

  // generic items (e.g., “level 3 pickaxe”)
  // normalize “level N → quality”
  s = s.replace(/\blevel\s*(1|2|3|4)\b/gi,(_,d)=> QUAL_MAP[+d]);

  // default to cleaned trimmed words without money words
  s = s.replace(/\b(price|budget|rent)\b[^.,;]*/gi,'').trim();

  // Capitalize first letter always
  if(s.length) s = s[0].toUpperCase() + s.slice(1);
  return s;
}

/* Amount extraction */
function detectAmount(raw){
  const r = raw.toLowerCase();

  // explicit numeric after keywords
  let m = r.match(/(?:price|budget|rent|bet)\s*[:\-]?\s*\$?\s*([\d.,]+(?:\s*[km]|m|k)?)/i);
  if(!m) m = r.match(/\$?\s*([\d.,]+(?:\s*[km]|m|k))(?:\s*each)?/i);
  if(!m) return 'Negotiable';

  const val = m[1].replace(/[, ]/g,'');
  return formatMoneyFromText(val);
}

/* End punctuation rule */
function ensureEndPunctuation(txt){
  return /\d$/.test(txt) ? txt : (txt.endsWith('.') ? txt : txt + '.');
}

/* Build the final ad */
function buildAd({action, cat, subject, amount}){
  // auto money label
  let label = MONEY_LABEL[action] || 'Price:';
  if(amount==='Negotiable') amount = 'Negotiable';

  // Real-Estate “Selling an apartment/house…” rule (“a/an” if no number)
  if(cat==='Real Estate' && /^(house|apartment|mansion|Casino penthouse)\b/i.test(subject)===false){
    // add an article when missing
    if(!subject.startsWith('a ') && !subject.startsWith('an ') && !subject.includes('№')) subject = 'a ' + subject;
  }

  const base = `${action} ${subject}. ${label} ${amount}`;
  // remove period when ends with a pure number value (e.g., … $20.000)
  return /\$\d[\d.]*$| Million$/.test(base) ? base : ensureEndPunctuation(base);
}

/* --------------------------- Badges --------------------------- */
function setChips(list){
  $.chips.innerHTML = '';
  list.forEach(x=>{
    const c = document.createElement('span'); c.className='chip'; c.textContent=x; $.chips.appendChild(c);
  });
}

/* --------------------------- Learning Rules --------------------------- */
const RULE_KEY='li_rules_v1';
function loadRules(){ try{ return JSON.parse(localStorage.getItem(RULE_KEY)||'[]'); }catch{ return [] } }
function saveRules(r){ localStorage.setItem(RULE_KEY, JSON.stringify(r)); }
function addRule(raw, patch){
  const rules = loadRules().filter(x=>x.raw!==raw.toLowerCase().trim());
  rules.unshift({raw:raw.toLowerCase().trim(), patch});
  saveRules(rules);
  updateRuleInfo();
}
function findRule(raw){
  const r = raw.toLowerCase().trim();
  return loadRules().find(x=> r===x.raw);
}
function updateRuleInfo(){
  const n = loadRules().length;
  $.ruleInfo.textContent = n ? `${n} rule${n>1?'s':''} saved. These will auto-apply to matching raw ads before parsing.` : 'No rules saved yet.';
}

/* --------------------------- Main Parse Flow --------------------------- */
function parseRaw(){
  const raw = $.raw.value.trim();
  if(!raw){ $.out.value=''; setChips([]); return; }

  // learning pre-patch
  if($.autoApply.checked){
    const rule = findRule(raw);
    if(rule){
      if(rule.patch.opener) $.mfOpen.value = rule.patch.opener;
      if(rule.patch.subject) $.mfSub.value = rule.patch.subject;
      if(rule.patch.amount) $.mfAmt.value = rule.patch.amount;
      if(rule.patch.label) $.mfLabel.value = rule.patch.label;
    }
  }

  // blacklist
  const bad = hasBlacklist(raw);
  if(bad){
    $.out.value = `Rejected: Cannot promote illegal/blacklisted content (“${bad}”).`;
    setChips(['Rejected','Blacklist']);
    return;
  }

  // detect
  const action = $.mfOpen.value.startsWith('Auto') ? detectAction(raw) : $.mfOpen.value;
  const cat = detectCategory(raw);
  const normalized = normalizeOpenSentence(raw, action, cat);
  let subject = $.mfSub.value ? $.mfSub.value.trim() : extractSubject(normalized, cat);
  let amount = $.mfAmt.value ? $.mfAmt.value.trim() : detectAmount(raw);
  const labelAuto = MONEY_LABEL[action] || 'Price:';
  const label = $.mfLabel.value.startsWith('Auto') ? labelAuto : $.mfLabel.value;

  // Final sentence
  let ad = `${action} ${subject}. ${label} ${formatMoneyFromText(amount)}`;
  ad = /\$\d[\d.]*$| Million$|Negotiable$|each$/.test(ad) ? ad : ensureEndPunctuation(ad);

  // Bad ending dot rule when ends with number → already handled above

  $.out.value = ad;
  $.mfCat.value = cat;
  setChips([`Detected: ${cat}`, `Action: ${action}`, `Money label: ${label.replace(':','')}`, 'Capitalization ✓', 'End punctuation ✓']);
}

/* --------------------------- Events --------------------------- */
$.gen.addEventListener('click', parseRaw);
$.clear.addEventListener('click', ()=>{
  $.raw.value=''; $.out.value=''; setChips([]); $.mfSub.value=''; $.mfAmt.value=''; $.mfOpen.value='Auto (detected)'; $.mfLabel.value='Auto (detected)'; $.mfCat.value='';
});
$.copy.addEventListener('click', ()=>{
  $.out.select(); document.execCommand('copy');
});

function applyFromManual(save){
  const raw = $.raw.value.trim();
  if(!raw) return;

  const patch = {
    opener: $.mfOpen.value.startsWith('Auto') ? '' : $.mfOpen.value,
    subject: $.mfSub.value.trim(),
    amount: $.mfAmt.value.trim(),
    label: $.mfLabel.value.startsWith('Auto') ? '' : $.mfLabel.value
  };
  // save rule?
  if(save){
    addRule(raw, patch);
  }
  parseRaw();
}

$.apply.addEventListener('click', ()=>applyFromManual(false));
$.applySave.addEventListener('click', ()=>applyFromManual(true));
$.autoApply.checked = localStorage.getItem('li_auto_apply')==='1';
$.autoApply.addEventListener('change', ()=> localStorage.setItem('li_auto_apply', $.autoApply.checked?'1':'0'));
updateRuleInfo();

/* --------------------------- Auto money label on opener change --------------------------- */
$.mfOpen.addEventListener('change', ()=>{
  if($.mfOpen.value && !$.mfOpen.value.startsWith('Auto')){
    const guess = MONEY_LABEL[$.mfOpen.value] || 'Price:';
    $.mfLabel.value = guess;
  } else {
    $.mfLabel.value = 'Auto (detected)';
  }
});

/* --------------------------- Demo examples (optional) --------------------------- */
if(!location.hash && !localStorage.getItem('li_first')){
  $.raw.value = 'selling plantation business no 5 price 50m';
  localStorage.setItem('li_first','1');
}
</script>
</body>
</html>
