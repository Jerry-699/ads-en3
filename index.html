<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lifeinvader EN-03 — Policy-Accurate Ad Formatter</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e7e8ea; --muted:#a8acb3; --card:#14161a; --accent:#6aa6ff; --ok:#3ecf8e; --warn:#ffb648; --bad:#ff5a7a; --chip:#1f2329;
    --shadow:0 8px 24px rgba(0,0,0,.25);
  }
  [data-theme="light"]{
    --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --accent:#2563eb; --ok:#10b981; --warn:#d97706; --bad:#e11d48; --chip:#eef2f7;
    --shadow:0 8px 24px rgba(15,23,42,.08);
  }
  html,body{height:100%;}
  body{
    margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,ui-monospace;
    background:var(--bg); color:var(--fg);
  }
  .app{max-width:1140px; margin:0 auto; padding:16px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .title{font-weight:800; letter-spacing:.2px; font-size:1.05rem}
  .mode{display:flex; align-items:center; gap:8px}
  .toggle{appearance:none; width:52px; height:28px; border-radius:999px; position:relative; background:var(--chip); outline:2px solid transparent; cursor:pointer; box-shadow:var(--shadow)}
  .toggle:before{content:""; position:absolute; width:22px; height:22px; border-radius:50%; top:3px; left:3px; background:var(--fg); transition:transform .2s ease}
  .toggle:checked{background:linear-gradient(90deg,var(--accent),#22d3ee)}
  .toggle:checked:before{transform:translateX(24px)}
  .grid{display:grid; grid-template-columns:1.3fr .7fr; gap:14px}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card); border-radius:16px; padding:14px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.06)}
  label{display:block; font-weight:700; margin-bottom:6px}
  textarea,input{width:100%; border-radius:12px; border:1px solid rgba(127,127,127,.25); background:transparent; color:var(--fg); padding:12px; outline:none}
  textarea{min-height:140px; resize:vertical}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .btn{appearance:none; border:0; padding:12px 14px; border-radius:12px; color:#fff; background:var(--accent); font-weight:800; cursor:pointer; box-shadow:var(--shadow)}
  .btn.secondary{background:#7c8596}
  .btn.ghost{background:transparent; color:var(--fg); border:1px dashed rgba(127,127,127,.35)}
  .muted{color:var(--muted); font-size:.92rem}
  .output{font-family:ui-monospace,Menlo,Consolas,monospace; background:var(--chip); border-radius:12px; padding:12px; white-space:pre-wrap; word-break:break-word}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{background:var(--chip); padding:6px 10px; border-radius:999px; font-size:.82rem}
  .chip.ok{background: rgba(16,185,129,.12); color:var(--ok)}
  .chip.bad{background: rgba(225,29,72,.12); color:var(--bad)}
  .list{display:grid; gap:10px}
  .ad{border:1px solid rgba(127,127,127,.25); border-radius:14px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), transparent)}
  .ad .hdr{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:6px}
  .ad .cat{font-weight:800; padding:4px 8px; border-radius:8px; background:var(--chip)}
  .ad .text{white-space:pre-wrap}
  .search-bar{display:flex; gap:8px}
  .pill{padding:8px 12px; border-radius:999px; background:var(--chip)}
  .warning{border-left:4px solid var(--warn); padding:8px 10px; background:rgba(217,119,6,.12); border-radius:10px; margin-top:8px}
  .error{border-left:4px solid var(--bad); padding:8px 10px; background:rgba(225,29,72,.12); border-radius:10px; margin-top:8px}
  .success{border-left:4px solid var(--ok); padding:8px 10px; background:rgba(16,185,129,.12); border-radius:10px; margin-top:8px}
  .small{font-size:.86rem}
</style>
</head>
<body data-theme="dark">
<div class="app">
  <header>
    <div class="title">Lifeinvader EN-03 • Policy-Accurate Ad Formatter</div>
    <div class="mode">
      <span class="pill small">Day / Night</span>
      <input id="themeToggle" class="toggle" type="checkbox" aria-label="Toggle theme" />
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: Composer -->
    <section class="card">
      <label for="raw">Raw ad text</label>
      <textarea id="raw" placeholder='e.g., selling house no 85 // buyyingng a Ruby. Price: Negotiable. // trading "Ubermacht m5 e34" with turbo // Party at bahama mamas'></textarea>

      <div class="row" style="margin-top:10px">
        <button id="formatBtn" class="btn">Generate formatted ad</button>
        <button id="addBtn" class="btn secondary" title="Adds the last formatted ad to the list">Add to list</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <div id="alerts"></div>

      <div style="margin-top:12px">
        <label>Formatted output</label>
        <div id="out" class="output" role="status" aria-live="polite"></div>
      </div>

      <div class="warning small" style="margin-top:10px">
        This tool follows your EN-03 policy: opener words, Price/Budget/Rent, money format, Real Estate features, Vehicle rules, Dating checks, Business terminology, Beach Market, parties allowlist, containers/resources/tuning, blacklist, and rejection reasons.
      </div>
    </section>

    <!-- RIGHT: Metadata -->
    <aside class="card">
      <label>Detected category</label>
      <div id="category" class="chips" style="margin-bottom:8px"><span class="chip">—</span></div>

      <label>Checks</label>
      <div id="checks" class="chips"></div>

      <div style="margin-top:12px">
        <label>Search ads</label>
        <div class="search-bar">
          <input id="search" placeholder="Search formatted list…" />
          <button id="searchBtn" class="btn">Search</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:space-between">
        <button id="exportBtn" class="btn ghost small">Export JSON</button>
        <button id="copyBtn" class="btn ghost small">Copy output</button>
      </div>
    </aside>
  </div>

  <!-- Ads list -->
  <section class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between; align-items:center">
      <label>Generated ads</label>
    </div>
    <div id="list" class="list"></div>
  </section>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const raw = $('raw'), out = $('out'), catChip = $('category'), checks = $('checks'), alerts = $('alerts'), list = $('list');
  const themeToggle = $('themeToggle'), search = $('search');

  // Theme
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  themeToggle.checked = savedTheme === 'light';
  themeToggle.addEventListener('change', () => {
    document.body.setAttribute('data-theme', themeToggle.checked ? 'light' : 'dark');
    localStorage.setItem('theme', themeToggle.checked ? 'light' : 'dark');
  });

  // Utilities
  const escapeHtml = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c]));
  const titleCaseFirst = s => s ? s[0].toUpperCase() + s.slice(1) : s;
  const lc = s => (s||'').toLowerCase();

  // Money helpers
  const dotsThousands = n => String(Math.trunc(Math.abs(Number(n)))).replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  function normalizeMoney(str){
    // Convert k/M shortcuts to policy, enforce $, dot-thousands, "Million", no trailing K/M
    return str
      // k / M suffixes
      .replace(/\$?\s*([\d.,]+)\s*([kKmM])\b/g, (_, num, suf) => {
        const val = parseFloat(String(num).replace(/,/g,'.'));
        if (!isFinite(val)) return `$${num}`;
        if (suf.toLowerCase()==='k') return `$${dotsThousands(Math.round(val*1000))}`;
        // M → Million
        return `$${val % 1 === 0 ? val.toFixed(0) : String(val)} Million`;
      })
      // plain numbers to $X with dot thousands (avoid touching things already like "Million")
      .replace(/\$?\s*(\d{1,3}(?:[,.]\d{3})+|\d+)(?!\s*Million)\b/g, (_,num)=>{
        const clean = String(num).replace(/,/g,'');
        if (!/^\d+(\.\d+)?$/.test(clean)) return `$${num}`;
        return `$${dotsThousands(clean)}`;
      })
      // Negotiable cap
      .replace(/\bnegotiable\b/gi,'Negotiable');
  }

  // Blacklist (full per policy)
  const BLACKLIST = new Set([
    'firearm','firearms','gun','guns','weapon','weapons','pistol','rifle','shotgun','ammo','ammunition',
    'bulletproof vest','bulletproof vests','armor plates','armor plate','armor','plate carrier',
    'weed','cannabis','cannabis seeds','weed seeds','trees','drug','drugs','cocaine',
    'ems surgical mask','surgical mask','medical mask','covid mask','ems mask',
    'vehicle scanner','human scanner','resource scanner','scanner','radar','anti-radar',
    'balaclava','balaclava mask','bandit mask',
    'rope','ropes','head bag','head bags',
    'usb with virus','virus usb',
    'lock pick','lock picks','lockpick','lockpicks','crowbar','crowbars',
    'troll','trolling',
    'animal skin',
    'satellite dish','barricade','engine block','air horn'
  ]);

  // Rejection reasons list (subset + key ones)
  const REASONS = {
    multiVehicles: 'Cannot advertise more than 1 vehicle at a time.',
    multiItemsOther: 'Cannot advertise more than 3 items at a time.',
    illegalItems: 'Cannot promote illegal items.',
    improper: 'Improper ad.',
    templateMissing: 'Template not found. Contact LI to create a template.',
    personNotFound: 'Person not found in database. (Person must be in the GRAND RP mail)',
    classifiedPerson: 'You cannot look for classified person.',
    itemNotFound: 'Item not found in database.',
    insufficientItem: 'Please, provide the correct name of the item you are selling.',
    insufficientItemBuy: 'Please, provide the correct name of the item you are buying.',
    badLicense: 'It is forbidden to publish license plates containing offensive language.',
    rentalPeriodMissing: 'Please indicate rental period.'
  };

  // Categories & signals
  const OFFICIAL_PLACES = [
    'Vinewood Hills','Rockford Hills','Richman','Sandy Shores','Paleto Bay','Postal','Hospital','Capitol','Fire Station','Auto Fair',
    'Bahama Mamas Bar','Tequi-la-la Bar','FIB','Hotel Spa Bar','Pacific Bluffs Country Club','Diamond Resort Bar','Vanilla Unicorn Bar',
    'Church','Stock Exchange','Stadium','Chumash','Lifeinvader','Del Perro Pier','Del Perro Beach','Cayo Perico Island','Hotel','Raton Canyon','School','SAHP'
  ];
  const UNOFFICIAL_PLACES = ['airport','autosalon','beach','beach market','ghetto','post office','train station','yacht'];

  function capitalizeOfficialPlaces(text){
    // Capitalize official, lower unofficial occurrences
    OFFICIAL_PLACES.forEach(p=>{
      const re = new RegExp(p.replace(/[()]/g,'\\$&'), 'ig');
      text = text.replace(re, p);
    });
    UNOFFICIAL_PLACES.forEach(p=>{
      const re = new RegExp(`\\b${p}\\b`, 'ig');
      text = text.replace(re, p.toLowerCase());
    });
    return text;
  }

  // Vehicle formatting helpers
  function quoteVehicleNames(s){
    // Ensure "Brand Model (Code)" is quoted; also normalize capitalization for examples like Ubermacht m5 e34
    return s.replace(/\b([A-Z][a-zA-Z]+)\s+([A-Za-z0-9\-]+(?:\s*\([^)]+\))?)\b(?!")/g,(m,brand,rest)=>{
      // avoid quoting common nouns
      const block = ['Selling','Buying','Trading','Selling or trading','Price','Budget','Rent','with','and','or','for','at','auto','car','cars','vehicle','vehicles'];
      if (block.includes(brand)) return m;
      // heuristic: if word is clearly a brand-like and followed by model, quote
      return `"${brand} ${rest.replace(/\s+/g,' ').replace(/\b([a-z])(\d)/g,(m,a,b)=>a.toUpperCase()+b)}"`;
    });
  }
  function mapVehicleUpgrades(s){
    // normalize config/visuals/turbo/drift order & phrases
    s = s
      .replace(/\b(max config|max tuning|fully upgraded)\b/ig,'with full configuration')
      .replace(/\b(nearly max|part\s*lvl\s*3|part lvl3|lvl3|partial config|some config|some tuning|chip tuning)\b/ig,'with partial configuration')
      .replace(/\b(body upgrades|body kit)\b/ig,'with visual upgrades')
      .replace(/\b(turbo)\b/ig,'turbo kit')
      .replace(/\b(drift (?:tuning|assistance))\b/ig,'drift kit')
      .replace(/\b(luminous (?:rims|unique wheels|unique rims|wheels))\b/ig,'luminous wheels');
    // enforce order after vehicle name
    s = s.replace(/"([^"]+)"([^\.]*?)\./g,(m,name,tail)=>{
      const bits = [];
      if (/with full configuration/i.test(tail)) bits.push('with full configuration');
      else if (/with partial configuration/i.test(tail)) bits.push('with partial configuration');
      if (/visual upgrades/i.test(tail)) bits.push('visual upgrades');
      if (/luminous wheels/i.test(tail)) bits.push('luminous wheels');
      if (/insurance/i.test(tail)) bits.push('insurance');
      if (/turbo kit/i.test(tail)) bits.push('turbo kit');
      if (/drift kit/i.test(tail)) bits.push('drift kit');
      const joined = bits.length ? ' ' + (bits[0].startsWith('with') ? bits[0] : 'with ' + bits[0]) + (bits.slice(1).length ? ', ' + bits.slice(1).join(', ') : '') : '';
      return `"${name}"${joined}.`;
    });
    return s;
  }

  // Real Estate helpers
  function normalizeRealEstateObject(obj){
    // number sign
    obj = obj.replace(/\b(house|apartment|penthouse|mansion)\s*(?:#|no\.?|number)?\s*(\d+)\b/ig,(m,t,n)=> `${t} №${n}`);
    // Casino apartment → Casino penthouse
    obj = obj.replace(/\bCasino apartment\b/ig,'Casino penthouse');
    // add article when number is absent
    if (/^(house|apartment|penthouse|mansion)\b(?!\s*№)/i.test(obj)) {
      obj = obj.replace(/^(house|apartment|penthouse|mansion)\b/i,(w)=> (/^[aeiou]/i.test(w)?'an ':'a ')+w);
    }
    return obj;
  }
  function orderRealEstateFeatures(txt){
    // collect features and reorder per policy
    const features = {
      garden: /(?:^|[\s,])garden\b/i.test(txt),
      gs_2: /\b2 g\.s\./i.test(txt),
      gs_5: /\b5 g\.s\./i.test(txt),
      gs_9: /\b9 g\.s\./i.test(txt),
      gs_25:/\b25 g\.s\./i.test(txt),
      wh: /\b(\d+)\s*w\.h\./i.exec(txt),
      custom: /custom interior/i.test(txt),
      insurance: /insurance/i.test(txt),
      helipad: /helipad/i.test(txt),
      others: []
    };
    if (/swimming pool/i.test(txt)) features.others.push('swimming pool');
    if (/(?:long|large) driveway/i.test(txt)) features.others.push('long driveway');
    if (/(?:spacious )?backyard/i.test(txt)) features.others.push('spacious backyard');
    if (/(?:nice|beautiful|great) views?/i.test(txt)) features.others.push('nice views');
    // build ordered string
    const parts = [];
    if (features.garden) parts.push('a garden');
    if (features.gs_2) parts.push('2 g.s.');
    if (features.gs_5) parts.push('5 g.s.');
    if (features.gs_9) parts.push('9 g.s.');
    if (features.gs_25) parts.push('25 g.s.');
    if (features.wh) parts.push(`${features.wh[1]} w.h.`);
    if (features.custom) parts.push('custom interior');
    if (features.insurance) parts.push('insurance');
    if (features.helipad) parts.push('helipad');
    parts.push(...features.others);
    if (!parts.length) return null;
    // commas, "and" before last, trailing period handled later
    return parts.length===1 ? parts[0] : parts.slice(0,-1).join(', ') + ' and ' + parts.slice(-1);
  }

  // Category detection (broad)
  const CATS = {
    "Real Estate": ['house','apartment','penthouse','mansion','g.s.','w.h.','helipad','garden','mirror park','vinewood','view','lifeinvader','casino penthouse'],
    "Auto": ['car','truck','motorcycle','bike','atv','boat','helicopter','plane','vehicle','insurance','drift kit','turbo kit','configuration','luminous wheels','auto fair','monowheel'],
    "Businesses": [
      'ammunition store','bar','car wash','chip tuning','clothing shop','cowshed','electric station','farm','flower shop','freight train','gas station','hair salon','jewelry store','oil well','parking','plantation','car sharing','state object','service station','24/7 store','tattoo studio','taxi company','atm','juice shop','burger shop','warehouse','grand elite'
    ],
    "Work": ['hiring','looking for work','looking for a job','salary','awarding','driver','lawyer','dj','photographer','bodyguard','assistant','professional dancer','professional singer','trucker','experience','construction site'],
    "Dating": ['looking for a','looking for','looking for friend','boyfriend','girlfriend','wife','husband','valentine','family','friends','casino poker players'],
    "Discounts": ['% discount','% off','off on all','offering','discount '],
    "Services": ['happy hour','template','join us','office','are you new in town','look no further','call us'],
    "Other": ['party','car meet','dice','fish','fishing rod','fruits','vegetables','mask','video card','repair kit','token','thread','snow','ticket','license plate','luminous wheels of type','pickaxe','tuning','elixir','pet','container','battery','fuel','wires','prime','prime platinum','sim card','lottery','resource','miner','inventory','backpack skin','tonic','pearl','statue','drawing','mushroom','paint can','timber','scrap metal','top quality metal','leash','hookah','charger','milk']
  };

  function detectCategory(text){
    const s = lc(text);
    for (const [k, arr] of Object.entries(CATS)){
      if (arr.some(w => s.includes(w))) return k;
    }
    return 'Other';
  }

  // Opener detection/normalization + label
  function detectOpener(s){
    const S = lc(s);
    if (/\bselling or trading\b/.test(S)) return 'Selling or trading';
    if (/\btrading\b/.test(S)) return 'Trading';
    if (/\bselling\b/.test(S)) return 'Selling';
    if (/\brenting out\b/.test(S)) return 'Renting out';
    if (/\brenting\b/.test(S)) return 'Renting';
    if (/\bbuying\b/.test(S) || /looking to (?:buy|purchase)/i.test(s) || /\blooking for\b/i.test(s)) return 'Buying';
    return null;
  }

  // Typos & canonical replacements
  function fixTypos(s){
    return s
      .replace(/buyyingng|buyying|buyyy?ing|buyin\b|looking to (?:buy|purchase)|look(?:ing)? to (?:buy|purchase)/gi,'Buying')
      .replace(/selling or trading|sell(?:ing)? ?\/ ?trading|s\/t/gi,'Selling or trading')
      .replace(/\btrad(?:e|ing)\b/gi,'Trading')
      .replace(/\brent(?:ing)? out\b/gi,'Renting out')
      .replace(/\brent(?:ing)?\b/gi,'Renting')
      .replace(/\bcasino apartment\b/gi,'Casino penthouse')
      // vehicle upgrade lexicon
      .replace(/\bmax config|max tuning|fully upgraded\b/gi,'with full configuration')
      .replace(/\bnearly max|part\s*lvl\s*3|lvl\s*3|partial config|some config|chip tuning\b/gi,'with partial configuration')
      .replace(/\bbody upgrades|body kit\b/gi,'with visual upgrades')
      .replace(/\bturbo\b/gi,'turbo kit')
      .replace(/\bdrift (?:tuning|assistance)\b/gi,'drift kit')
      .replace(/\bluminous (?:rims|unique wheels|unique rims|wheels)\b/gi,'luminous wheels')
      // terms to "type"
      .replace(/\bextras\b/gi,'of type')
      ;
  }

  // Money line build
  function moneyLineFor(opener, existing){
    if (opener === 'Renting out') return existing || 'Rent: Negotiable.';
    if (opener === 'Buying') return existing || 'Budget: Negotiable.';
    if (opener === 'Trading') return existing || ''; // can be empty
    if (opener === 'Selling or trading' || opener === 'Selling') return existing || 'Price: Negotiable.';
    return existing || '';
  }

  function extractMoneySentence(s){
    const m = /(Price|Budget|Rent)\s*:?\s*([^.]*)/i.exec(s);
    if (!m) return null;
    let label = titleCaseFirst(m[1].toLowerCase());
    let rest = m[2].trim();
    if (!rest) rest = 'Negotiable';
    rest = normalizeMoney(rest);
    // If ends with number (not Million word), omit trailing period
    const tail = /\d(?:\.\d{3})*(?!.*Million$)/.test(rest) ? '' : '.';
    return `${label}: ${rest}${tail}`;
  }

  function endsWithNumberSentence(s){
    return /\d$/.test(s.trim());
  }

  // License plate simple validity (length 3-7 when provided)
  function validLicensePlate(s){
    const m = /\blicense plate\s*\(([^)]+)\)/i.exec(s);
    if (!m) return true;
    const val = m[1].trim();
    return val.length>=3 && val.length<=7;
  }

  // Party location allowlist (for "Other")
  const PARTY_OK = new Set([
    'house','apartment','beach','yacht','bahama mamas bar','tequi-la-la bar','stadium','diamond resort bar','arena','raton canyon','vanilla unicorn bar','hotel spa bar'
  ]);

  function validatePartyLocation(s, problems){
    const m = /\bparty at (.+?)\.?$/i.exec(s);
    if (!m) return;
    const place = lc(m[1]).replace(/\s+market.*$/,'').trim();
    if (!Array.from(PARTY_OK).some(x => place.includes(x))) {
      problems.push({type:'warning', msg:'Party location may be disallowed per list of places we don’t promote.'});
    }
  }

  // Dating validation: require First + Last; capitalize; cannot set price/budget
  function normalizeDating(s, problems){
    if (!/^looking for/i.test(s.trim())) return s;
    // "Looking for Name Surname."
    const nameMatch = /looking for\s+([a-z]+)\s+([a-z]+)\b/i.exec(s);
    if (nameMatch){
      const full = `${titleCaseFirst(nameMatch[1])} ${titleCaseFirst(nameMatch[2])}`;
      s = s.replace(nameMatch[0], `Looking for ${full}`);
    } else if (/looking for a (wife|husband|boyfriend|girlfriend|friend|family( members)?|valentine)/i.test(s)) {
      s = s.replace(/^looking for/i,'Looking for');
    } else {
      problems.push({type:'error', msg:'Please provide full first and last name for the person you are looking for.'});
    }
    if (/Price:|Budget:/i.test(s)) problems.push({type:'error', msg:'Looking/Dating ads must not include Price or Budget values.'});
    return s;
  }

  // Business name normalization
  function normalizeBusinessTerms(s){
    return s
      .replace(/\bgun store|weapon store\b/ig,'Ammunition Store')
      .replace(/\bbarber\b/ig,'Hair salon')
      .replace(/\bcharging station\b/ig,'Electric station')
      .replace(/\bservice station(?: \(auto workshop\))?/ig,'Service station')
      .replace(/\bdrug lab\b/ig,'Burger shop')
      .replace(/\bpersonal business\b/ig,'private business');
  }

  // Beach Market phrasing
  function normalizeBeachMarket(s){
    // change "cheap prices" -> "for good prices"
    s = s.replace(/\bcheap prices?\b/ig,'for good prices');
    return s;
  }

  function enforceVehicleTradingParity(s, problems){
    // Vehicle↔Vehicle, Business↔Business, Other↔Other checks (basic)
    if (/trading/i.test(s)) {
      // find “for” pattern
      if (/trading\b.+\bfor\b/i.test(s)){
        const leftAuto = /"(?:[^"]+)"|car|vehicle|bike|boat|helicopter|plane|monowheel/i.test(s);
        const rightAuto = /\bfor\b.+(?:"[^"]+"|car|vehicle|bike|boat|helicopter|plane|monowheel)/i.test(s);
        if (leftAuto && !rightAuto) problems.push({type:'error', msg:'Can only trade a Vehicle for another Vehicle.'});
      }
    }
  }

  function periodRule(sentence){
    // If ad ends with a number → no dot; else add dot
    sentence = sentence.trim();
    if (endsWithNumberSentence(sentence)) return sentence;
    if (!/[.]$/.test(sentence)) sentence += '.';
    return sentence;
  }

  // Formatting pipeline
  function formatAd(input){
    alerts.innerHTML = '';
    const problems = [];

    if (!input || !input.trim()) return {formatted:'', category:'—', problems};

    // 0) quick blacklist scan (raw)
    {
      const s = lc(input);
      for (const bad of BLACKLIST) if (s.includes(bad)) {
        problems.push({type:'error', msg:`Rejected: contains blacklisted term: ${bad}`});
      }
    }

    // 1) normalize text / terms
    let s = fixTypos(input);
    s = normalizeBusinessTerms(s);
    s = normalizeBeachMarket(s);
    s = capitalizeOfficialPlaces(s);

    // 2) detect opener; default to Selling
    let opener = detectOpener(s) || 'Selling';

    // 3) normalize object phrase (incl. real estate & vehicles quoting)
    // a) for real estate
    s = s.replace(/\b(house|apartment|penthouse|mansion)\b[^.]*\b/gi,(m)=> normalizeRealEstateObject(m));
    // b) vehicles
    s = quoteVehicleNames(s);
    s = mapVehicleUpgrades(s);

    // 4) dating normalization & checks
    if (/^looking for/i.test(s.trim())) {
      opener = 'Buying'; // policy maps “Looking to buy” to Buying, but “Looking for …” is Dating category; do not change opener word here; we format as “Looking for ….”
      s = normalizeDating(s, problems);
    }

    // 5) Build first sentence: must begin with the opener (capitalized)
    // extract a core object phrase after opener if present; otherwise keep opener + generic
    let firstSentence;
    {
      // normalize “Looking to buy/purchase” already mapped to Buying earlier
      const m = new RegExp(`\\b(${['Selling or trading','Selling','Trading','Buying','Renting out','Renting','Looking for'].join('|')})\\b\\s*([^.]*)`,'i').exec(s);
      let obj = m ? (m[2]||'').trim() : '';
      // trim trailing "Price/Budget/Rent" segments from obj for clarity
      obj = obj.replace(/\s*(Price|Budget|Rent)\s*:.*$/i,'').trim();

      // glue first sentence
      let openerOut = opener;
      if (/^looking for/i.test(s.trim())) openerOut = 'Looking for'; // preserve exact wording for Dating
      firstSentence = openerOut + (obj ? ' ' + obj : (opener==='Buying'?' a car':' a house'));
      firstSentence = firstSentence.replace(/\s+\.$/,'');
      firstSentence = titleCaseFirst(firstSentence);
      firstSentence = periodRule(firstSentence);
    }

    // 6) Money sentence (normalize existing or add default)
    let mline = extractMoneySentence(s);
    mline = moneyLineFor(opener, mline);

    // 7) Category
    let formattedPreview = [firstSentence, mline].filter(Boolean).join(' ');
    let category = detectCategory(formattedPreview);

    // 8) Category-specific rules & extra validations

    // Auto: one vehicle per ad unless trading
    if (category==='Auto'){
      const quotedVehicles = (formattedPreview.match(/"[^"]+"/g)||[]);
      const isTrading = /\btrading\b/i.test(formattedPreview) || /\bselling or trading\b/i.test(formattedPreview);
      if (!isTrading && quotedVehicles.length>1) problems.push({type:'error', msg:REASONS.multiVehicles});
      enforceVehicleTradingParity(formattedPreview, problems);
    }

    // Other: max 3 items
    if (category==='Other'){
      const itemsCount = (formattedPreview.match(/(?:Selling|Buying)\s+[^.]+?\./gi)||[]).length || 1;
      if (itemsCount>3) problems.push({type:'error', msg:REASONS.multiItemsOther});
      // party validation hint
      validatePartyLocation(firstSentence, problems);
    }

    // Real Estate: order features
    if (category==='Real Estate'){
      // build ordered features line if features exist and inject into first sentence “with …”
      const feats = orderRealEstateFeatures(firstSentence);
      if (feats && !/ with /.test(firstSentence)){
        firstSentence = firstSentence.replace(/\.$/,'') + ' with ' + feats + '.';
      }
      // apartments cannot be insured (ensure we didn't add it)
      if (/apartment №\d+.*insurance/i.test(firstSentence)){
        problems.push({type:'warning', msg:'Apartments cannot be insured; remove “insurance”.'});
      }
      // houses/apartments not tradable
      if (/\b(trading|selling or trading)\b/i.test(firstSentence) && /\b(house|apartment|penthouse|mansion)\b/i.test(firstSentence)){
        problems.push({type:'error', msg:'Houses and apartments are not tradable.'});
      }
    }

    // License plate format
    if (!validLicensePlate(formattedPreview)) {
      problems.push({type:'error', msg:'License plate must be 3–7 characters in length.'});
    }

    // Beach market: generally no “Negotiable” needed; keep if price specified examples allow both, but we’ll remove redundant Negotiable-only lines when at Auto Fair or Beach Market templates
    if (/at beach market/i.test(lc(formattedPreview)) && /Negotiable\.$/.test(lc(mline||''))){
      mline = ''; // policy: Don’t need to mention negotiable.
    }

    // Work: “level” → “years experience”
    if (category==='Work'){
      formattedPreview = formattedPreview.replace(/\blevel\b/ig,'years experience');
    }

    // 9) rebuild formatted after adjustments
    formattedPreview = [firstSentence, mline].filter(Boolean).join(' ').replace(/\s+/g,' ').trim();

    // 10) Checks (caps, labels, №, punctuation)
    renderChecks({formatted:formattedPreview, opener});

    return {formatted:formattedPreview, category, problems};
  }

  function renderChecks({formatted, opener}){
    checks.innerHTML = '';
    const add = (t, cls='')=>{
      const span = document.createElement('span'); span.className='chip '+cls; span.textContent=t; checks.appendChild(span);
    };
    /^[A-Z]/.test(formatted) ? add('Capitalization ✓','ok') : add('Capitalization ✕','bad');
    if (opener==='Buying' && /Budget:/.test(formatted)) add('Buyer→Budget ✓','ok');
    else if ((opener==='Selling'||opener==='Selling or trading') && /Price:/.test(formatted)) add('Seller→Price ✓','ok');
    else if (opener==='Renting out' && /Rent:/.test(formatted)) add('Rent ✓','ok');
    else if (/Trading/.test(opener) && !/Price:|Budget:/.test(formatted)) add('Trading money (optional) ✓','ok');
    else add('Money label ✕','bad');

    /(?:house|apartment|penthouse|mansion) №\d+/i.test(formatted) ? add('№ format ✓','ok') : add('№ format —');
    /(\.|\d)$/.test(formatted.trim()) ? add('End punctuation ✓','ok') : add('End punctuation ✕','bad');
  }

  // UI & list
  const ADS = [];
  function renderList(items, q=''){
    const needle = lc(q.trim());
    list.innerHTML = '';
    items.filter(i => !needle || lc(i.text).includes(needle) || lc(i.category).includes(needle)).forEach(i=>{
      const div = document.createElement('div');
      div.className='ad';
      div.innerHTML = `
        <div class="hdr">
          <div class="cat">${escapeHtml(i.category)}</div>
          <div class="muted small">${new Date(i.id).toLocaleString()}</div>
        </div>
        <div class="text">${escapeHtml(i.text)}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn ghost small" data-copy="${i.id}">Copy</button>
          <button class="btn ghost small" data-del="${i.id}">Delete</button>
        </div>
      `;
      list.appendChild(div);
    });
    list.querySelectorAll('button[data-copy]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = Number(b.getAttribute('data-copy'));
        const item = ADS.find(x=>x.id===id);
        navigator.clipboard.writeText(item.text);
        b.textContent='Copied ✓'; setTimeout(()=>b.textContent='Copy',900);
      });
    });
    list.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = Number(b.getAttribute('data-del'));
        const idx = ADS.findIndex(x=>x.id===id);
        if (idx>=0){ ADS.splice(idx,1); renderList(ADS, search.value); }
      });
    });
  }

  // Buttons
  $('formatBtn').addEventListener('click', ()=>{
    const {formatted, category, problems} = formatAd(raw.value);
    out.textContent = formatted;
    catChip.innerHTML = `<span class="chip">${category}</span>`;
    renderProblems(problems);
  });

  $('addBtn').addEventListener('click', ()=>{
    const text = out.textContent.trim(); if (!text) return;
    const category = detectCategory(text);
    ADS.push({id:Date.now(), text, category});
    renderList(ADS);
    raw.value=''; out.textContent=''; catChip.innerHTML=`<span class="chip">—</span>`;
    alerts.innerHTML = `<div class="success">Added to list.</div>`; setTimeout(()=>alerts.innerHTML='',1500);
  });

  $('clearBtn').addEventListener('click', ()=>{ raw.value=''; out.textContent=''; alerts.innerHTML=''; catChip.innerHTML=`<span class="chip">—</span>`; });

  $('searchBtn').addEventListener('click', ()=> renderList(ADS, search.value));
  search.addEventListener('keydown', e=>{ if(e.key==='Enter') $('searchBtn').click(); });

  $('exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(ADS,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='ads.json'; a.click(); URL.revokeObjectURL(url);
  });

  $('copyBtn').addEventListener('click', ()=>{
    const t = out.textContent.trim(); if(!t) return;
    navigator.clipboard.writeText(t); $('copyBtn').textContent='Copied ✓'; setTimeout(()=>$('copyBtn').textContent='Copy output',900);
  });

  function renderProblems(problems){
    alerts.innerHTML='';
    problems.forEach(p=>{
      const div = document.createElement('div');
      div.className = p.type==='error' ? 'error' : 'warning';
      div.textContent = p.msg;
      alerts.appendChild(div);
    });
  }

  // Demo fill
  raw.value = 'selling house no 85';
  $('formatBtn').click(); // → Selling house №85. Price: Negotiable.
})();
</script>
</body>
</html>
