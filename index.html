<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
  <title>Lifeinvader Ads — EN-03 Policy Accurate (Auto Detect)</title>

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700,900|Roboto+Slab:400,700">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>

  <!-- Material Kit CSS -->
  <link id="pagestyle" href="https://cdn.jsdelivr.net/gh/creativetimofficial/material-kit@3.0.4/assets/css/material-kit.css" rel="stylesheet"/>

  <style>
    :root{ --ok:#10b981; --warn:#d97706; --bad:#e11d48; }
    .note{font-size:.9rem;color:#64748b}
    .chip{display:inline-block;padding:.25rem .5rem;border-radius:999px;background:#f1f5f9;margin:.15rem 0;font-size:.8rem}
    .chip.ok{background:rgba(16,185,129,.12);color:var(--ok)}
    .chip.warn{background:rgba(217,119,6,.12);color:var(--warn)}
    .chip.bad{background:rgba(225,29,72,.12);color:var(--bad)}
    .policy-box{border-left:4px solid #3b82f6;background:#eff6ff;padding:.5rem .75rem;border-radius:.5rem}
    .error-box{border-left:4px solid var(--bad);background:rgba(225,29,72,.08);padding:.5rem .75rem;border-radius:.5rem}
    .btn-clear{white-space:nowrap}
    .opacity-4{opacity:.35}
    .small{font-size:.9rem}
    /* Dark mode toggle (optional) */
    @media (prefers-color-scheme: dark){
      body.index-page.bg-gray-200{ background:#0b1220; }
      .card.card-body{ background:rgba(17,24,39,.8) !important; color:#e5e7eb; }
      .policy-box{ background:rgba(59,130,246,.12); }
      .input-group .form-control[readonly]{ background:#0f172a; color:#e5e7eb; }
    }
  </style>
</head>
<body class="index-page bg-gray-200">

  <header class="header-2">
    <div class="page-header min-vh-25" style="background-image:url('https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?q=80&w=1600&auto=format&fit=crop'); background-position:center;">
      <span class="mask bg-gradient-primary opacity-4"></span>
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto text-center">
            <h1 class="text-white pt-3">Lifeinvader Ads — EN-03</h1>
            <p class="lead text-white">Policy-accurate ad builder with <b>Auto-Detect</b> raw ad parser</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="card card-body blur shadow-blur mx-3 mx-md-4 mt-n6">
    <section class="pt-3 pb-4">
      <div class="container">
        <div class="row">
          <div class="col-lg-10 mx-auto">

            <!-- Policy note -->
            <div class="policy-box mb-3 small">
              Paste <b>any raw ad</b> below. The parser auto-detects <b>category</b>, <b>action</b>, and <b>money label</b>, fixes money formats, applies Real Estate / Auto / Business / Dating / Work rules, blocks blacklisted content, and outputs a <b>policy-perfect</b> ad.
            </div>

            <!-- NEW: Auto-Detect (Raw Ad) -->
            <div class="card shadow-sm mb-4">
              <div class="card-header">
                <h5 class="mb-0"><span class="material-icons align-middle">bolt</span> Auto-Detect (Raw Ad)</h5>
              </div>
              <div class="card-body">
                <label for="rawInput" class="form-label">Raw ad text</label>
                <textarea id="rawInput" class="form-control" rows="4" placeholder='e.g., selling house no 85 with garden. price negotiable OR "looking to buy ruby price negotiable" OR selling Ubermacht M5 (E34) full config + insurance 8m'></textarea>
                <div class="note mt-2">
                  Examples it fixes: <b>selling house no 85</b> → <i>Selling house №85. Price: Negotiable.</i> •
                  <b>buyyingng a Ruby. Price: Negotiable.</b> → <i>Buying a ruby. Budget: Negotiable.</i> •
                  <b>looking to purchase car</b> → <i>Buying a car. Budget: Negotiable.</i>
                </div>
                <div class="d-flex gap-2 mt-3">
                  <button class="btn bg-gradient-primary" onclick="generateFromRaw()">Generate</button>
                  <button class="btn bg-gradient-secondary" onclick="clearRaw()">Clear</button>
                </div>
              </div>
            </div>

            <!-- OUTPUT -->
            <div class="row mt-2">
              <div class="col-12">
                <h6>Formatted Output</h6>
                <div class="input-group input-group-outline my-2">
                  <input id="finalOutput" class="form-control" readonly placeholder="Your formatted ad will appear here…">
                  <button class="btn bg-gradient-primary" onclick="copyText()">Copy text</button>
                </div>
                <div id="chips" class="mt-1"></div>
                <div id="checks" class="mt-2"></div>
                <div id="errors" class="mt-2"></div>
              </div>
            </div>

            <!-- (Optional) You can keep or delete the manual tabs below. Auto-Detect is independent. -->
            <hr class="my-5"/>
            <div class="note">Manual builders from earlier remain below (optional). You can remove this section if you only want Auto-Detect.</div>

            <ul class="nav nav-pills nav-fill p-1 bg-gray-100 mt-3" role="tablist">
              <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-real" role="tab"><span class="material-icons align-middle mb-1">location_city</span> Real Estate</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-auto" role="tab"><span class="material-icons align-middle mb-1">directions_car</span> Auto</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-other" role="tab"><span class="material-icons align-middle mb-1">all_inclusive</span> Other</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-biz" role="tab"><span class="material-icons align-middle mb-1">store</span> Business</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-dating" role="tab"><span class="material-icons align-middle mb-1">favorite</span> Dating</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-work" role="tab"><span class="material-icons align-middle mb-1">engineering</span> Work</a></li>
            </ul>

            <div class="tab-content pt-3">
              <!-- Keep your previous manual forms if you want (omitted here for brevity). -->
              <div class="tab-pane fade show active" id="tab-real" role="tabpanel">
                <div class="small text-secondary">Manual Real Estate form removed for brevity. Auto-Detect covers it.</div>
              </div>
              <div class="tab-pane fade" id="tab-auto" role="tabpanel"><div class="small text-secondary">Manual Auto form removed for brevity.</div></div>
              <div class="tab-pane fade" id="tab-other" role="tabpanel"><div class="small text-secondary">Manual Other form removed for brevity.</div></div>
              <div class="tab-pane fade" id="tab-biz" role="tabpanel"><div class="small text-secondary">Manual Business form removed for brevity.</div></div>
              <div class="tab-pane fade" id="tab-dating" role="tabpanel"><div class="small text-secondary">Manual Dating form removed for brevity.</div></div>
              <div class="tab-pane fade" id="tab-work" role="tabpanel"><div class="small text-secondary">Manual Work form removed for brevity.</div></div>
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer py-4">
    <div class="container text-center small">
      Built for EN-03 policy accuracy — auto category, zero formatting mistakes.
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
    // ===== Utilities & Constants =====
    const $ = id => document.getElementById(id);
    const lc = s => (s||'').toLowerCase();
    const tcFirst = s => s ? s[0].toUpperCase() + s.slice(1) : s;

    const OFFICIAL_PLACES = ['Vinewood Hills','Rockford Hills','Richman','Sandy Shores','Paleto Bay','Postal','Hospital','Capitol','Fire Station','Auto Fair','Bahama Mamas Bar','Tequi-la-la Bar','FIB','Hotel Spa Bar','Pacific Bluffs Country Club','Diamond Resort Bar','Vanilla Unicorn Bar','Church','Stock Exchange','Stadium','Chumash','Lifeinvader','Del Perro Pier','Del Perro Beach','Cayo Perico Island','Hotel','Raton Canyon','School','SAHP'];
    const UNOFFICIAL_PLACES = ['airport','autosalon','beach','beach market','ghetto','post office','train station','yacht'];

    const BLACKLIST = new Set([
      'firearm','firearms','gun','guns','weapon','weapons','pistol','rifle','shotgun','ammo','ammunition',
      'bulletproof vest','bulletproof vests','armor plates','armor plate','armor',
      'weed','cannabis','cannabis seeds','weed seeds','drug','drugs','cocaine',
      'ems surgical mask','surgical mask','medical mask','covid mask','ems mask',
      'vehicle scanner','human scanner','resource scanner','scanner','radar','anti-radar',
      'balaclava','balaclava mask','bandit mask',
      'rope','ropes','head bag','head bags',
      'usb with virus',
      'lock pick','lock picks','lockpick','lockpicks','crowbar','crowbars',
      'animal skin','satellite dish','barricade','engine block','air horn'
    ]);

    const BUSINESS_LIST = ['Ammunition Store','Bar','Car wash','Chip tuning','Clothing shop','Cowshed','Electric station','Farm','Flower shop','Freight train','Gas station','Hair salon','Jewelry store','Oil Well','Parking','Plantation','Car sharing','State object','Service station','24/7 Store','Tattoo studio','Taxi company','ATM','Juice shop','Burger shop','Warehouse'];

    const dotThousands = n => String(Math.trunc(Math.abs(Number(n)))).replace(/\B(?=(\d{3})+(?!\d))/g, '.');

    function normalizeMoney(str){
      if (!str) return '';
      let t = ' ' + String(str).trim() + ' ';
      // Looking for shorthand $1k / 1.7k / 3m etc.
      t = t.replace(/\$?\s*([\d.,]+)\s*([kKmM])\b/g, (_, num, suf) => {
        const val = parseFloat(String(num).replace(/,/g,'.'));
        if (!isFinite(val)) return `$${num}`;
        if (suf.toLowerCase()==='k') return `$${dotThousands(Math.round(val*1000))}`;
        return `$${val % 1 === 0 ? val.toFixed(0) : String(val)} Million`;
      });
      // Raw numbers to $X or $X.X with dot-thousands (skip if followed by "Million")
      t = t.replace(/\$?\s*(\d{1,3}(?:[,.]\d{3})+|\d+)(?!\s*Million)\b/g, (_, num) => {
        const clean = String(num).replace(/,/g,'');
        if (!/^\d+(\.\d+)?$/.test(clean)) return `$${num}`;
        return `$${dotThousands(clean)}`;
      });
      t = t.replace(/\bnegotiable\b/ig,'Negotiable');
      t = t.replace(/\beach\b/ig,'each'); // normalize 'each'
      return t.trim();
    }
    function addEndPeriod(s){
      s = s.trim();
      if (/\d$/.test(s) && !/\bMillion\.$/i.test(s)) return s;
      if (!s.endsWith('.')) s += '.';
      return s;
    }
    function fixPlaces(text){
      OFFICIAL_PLACES.forEach(p => text = text.replace(new RegExp(p.replace(/[()]/g,'\\$&'), 'ig'), p));
      UNOFFICIAL_PLACES.forEach(p => text = text.replace(new RegExp(`\\b${p}\\b`, 'ig'), p.toLowerCase()));
      return text;
    }
    function containsBlacklist(str){
      const s = lc(str);
      for (const bad of BLACKLIST) if (s.includes(bad)) return bad;
      return null;
    }
    function licenseOK(text){
      const m = /\blicense plate\s*\(([^)]+)\)/i.exec(text);
      if (!m) return true;
      const val = m[1].trim();
      return val.length>=3 && val.length<=7;
    }
    function copyText(){
      const v = $('finalOutput').value.trim();
      if (!v) return;
      navigator.clipboard.writeText(v);
    }
    function clearRaw(){
      $('rawInput').value='';
      $('finalOutput').value='';
      $('chips').innerHTML='';
      $('checks').innerHTML='';
      $('errors').innerHTML='';
    }
    function chip(label, cls=''){ return `<span class="chip ${cls}">${label}</span> `; }
    function showChips({category, action, moneyLabel}){
      $('chips').innerHTML = chip(`Detected: ${category}`,'ok') + chip(`Action: ${action}`,'ok') + (moneyLabel? chip(`Money: ${moneyLabel}`,'ok'):'');
    }
    function setChecks(txt, opener){
      const box = $('checks'); box.innerHTML = '';
      const add = (msg, cls='') => box.insertAdjacentHTML('beforeend', `<span class="chip ${cls}">${msg}</span> `);
      /^[A-Z]/.test(txt) ? add('Capitalization ✓','ok') : add('Capitalization ✕','bad');
      if (opener==='Buying') /Budget:/.test(txt) ? add('Buyer→Budget ✓','ok') : add('Buyer→Budget ✕','bad');
      if (opener==='Selling' || opener==='Selling or trading') /Price:/.test(txt) ? add('Seller→Price ✓','ok') : add('Seller→Price ✕','bad');
      if (opener==='Renting out') /Rent:/.test(txt) ? add('Rent ✓','ok') : add('Rent ✕','bad');
      /(\.|\d)$/.test(txt.trim()) ? add('End punctuation ✓','ok') : add('End punctuation ✕','bad');
      if (!licenseOK(txt)) add('License plate len ✕','bad'); else if (/\blicense plate\b/i.test(txt)) add('License plate ✓','ok');
    }
    function setErrors(arr){
      const box = $('errors'); box.innerHTML = '';
      arr.forEach(e => box.insertAdjacentHTML('beforeend', `<div class="error-box">${e}</div>`));
    }

    // ===== Auto Detection =====
    function detectAction(raw){
      let s=lc(raw);
      if (/\brenting\s+out\b|\brent(?:ing)?\b/.test(s)) return 'Renting out';
      if (/\bselling\s+or\s+trading\b/.test(s)) return 'Selling or trading';
      if (/\btrading\b|\btrade\b/.test(s)) return 'Trading';
      if (/\bbuy(?:ing|)\b|\blooking\s+to\s+buy\b|\blooking\s+to\s+purchase\b|\bpurchase\b/.test(s)) return 'Buying';
      if (/\bsell(?:ing)?\b/.test(s)) return 'Selling';
      if (/^looking\s+for\b/.test(s)) return 'Looking for';
      return 'Selling'; // safe default
    }
    function moneyLabelFor(opener){
      if (opener==='Buying') return 'Budget';
      if (opener==='Renting out') return 'Rent';
      if (opener==='Trading') return ''; // optional
      if (opener==='Looking for') return ''; // no money line in dating lookups
      return 'Price';
    }
    function detectCategory(raw){
      const s = lc(raw);
      // Real Estate signals
      if (/\b(house|apartment|penthouse|mansion)\b/.test(s)) return 'Real Estate';
      if (/\b(g\.s\.|w\.h\.|helipad|custom interior)\b/.test(s)) return 'Real Estate';
      // Auto signals
      if (/\bdrift kit|turbo kit|visual upgrades|luminous wheels|with full configuration|with partial configuration\b/.test(s)) return 'Auto';
      if (/\"[^"]+\"/.test(raw)) return 'Auto'; // vehicle in quotes often
      // Business signals
      for (const b of BUSINESS_LIST){ if (s.includes(lc(b))) return 'Business'; }
      if (/\bstate object\b|\bcontrol\b.*\b(station|store|sharing|tuning)\b/.test(s)) return 'Business';
      // Dating
      if (/^looking\s+for\b/.test(s) && /\b(boyfriend|girlfriend|wife|husband|valentine|friends?|family|casino poker players)\b/.test(s)) return 'Dating';
      // Work
      if (/\bhiring\b|\blooking\s+for\s+work\b|\blooking\s+to\s+work\b|\bsalary\b|\bconstruction site №\d\b/.test(s)) return 'Work';
      // Other default
      return 'Other';
    }

    // ===== Policy Builders per Category =====
    function buildReal(opener, s){
      const errors=[];
      // number
      let numMatch = s.match(/\b(?:no\.?|number|num|#|№)\s*([0-9]{1,6})\b/i) || s.match(/\b(house|apartment|penthouse|mansion)\s*(?:no\.?|number|num|#|№)?\s*([0-9]{1,6})\b/i);
      let typeMatch = s.match(/\b(house|apartment|penthouse|mansion)\b/i);
      let type = typeMatch ? typeMatch[1].toLowerCase() : 'house';
      let subject;
      if (numMatch && numMatch[2]) subject = `${type} №${numMatch[2]}`;
      else if (numMatch && numMatch[1]) subject = `${type} №${numMatch[1]}`;
      else subject = (/^[aeiou]/i.test(type)?'an ':'a ') + type;

      // features detect
      const feats=[];
      if (/\bgarden\b/i.test(s)) feats.push('a garden');
      const gs = s.match(/\b(2|5|9|25)\s*(?:g\.?s\.?)\b/i);
      if (gs) feats.push(`${gs[1]} g.s.`);
      const wh = s.match(/\b(\d+)\s*(?:w\.?h\.?)\b/i);
      if (wh) feats.push(`${wh[1]} w.h.`);
      if (/\bcustom\s+interior\b/i.test(s)) feats.push('custom interior');
      if (/\binsurance\b/i.test(s) && type!=='apartment') feats.push('insurance');
      else if (/\binsurance\b/i.test(s) && type==='apartment') errors.push('Apartments cannot be insured.');
      if (/\bhelipad\b/i.test(s)) feats.push('helipad');
      const other = [];
      if (/\bswimming\s+pool\b/i.test(s)) other.push('swimming pool');
      if (/\btennis\s+court\b/i.test(s)) other.push('tennis court');
      if (/\blong\s+driveway\b/i.test(s)) other.push('long driveway');
      if (/\b(spacious\s+)?backyard\b/i.test(s)) other.push('spacious backyard');
      if (/\b(nice|beautiful|great)\s+views?\b/i.test(s)) other.push(RegExp.$1 ? `${RegExp.$1} views` : 'nice views');
      feats.push(...other);

      if (feats.length){
        const tail = feats.length===1 ? feats[0] : feats.slice(0,-1).join(', ') + ' and ' + feats.slice(-1);
        subject += ` with ${tail}`;
      }

      // location
      let locMatch = s.match(/\b(in|near)\s+([A-Za-z][A-Za-z ]+[A-Za-z])\b/);
      if (locMatch){
        subject += ` ${locMatch[1]} ${locMatch[2]}`;
      }

      subject = subject.replace(/\bCasino apartment\b/ig,'Casino penthouse');
      subject = tcFirst(subject);
      subject = addEndPeriod(fixPlaces(subject));

      // money line
      let label = moneyLabelFor(opener);
      let amtRaw = (s.match(/\b(price|budget|rent)\s*[:\-]?\s*([^.,\n]+(?:Million)?(?:\s*each)?)\b/i) || [,'', ''])[2] || (s.match(/\$(?:\s*)[\d\.\,]+(?:\s*Million)?(?:\s*each)?/i)||[''])[0];
      let mline = '';
      if (label){
        if (!amtRaw || /negotiable/i.test(amtRaw)) mline = `${label}: Negotiable.`;
        else {
          const norm = normalizeMoney(amtRaw);
          const endNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
          mline = `${label}: ${norm}${endNum?'':'.'}`;
        }
      }

      // not tradable check
      if ((opener==='Trading' || opener==='Selling or trading') && /\b(house|apartment|penthouse|mansion)\b/i.test(subject)) {
        errors.push('Houses and apartments are not tradable.');
      }

      return { text: `${opener} ${subject}${mline?' '+mline:''}`, errors };
    }

    function buildAuto(opener, s){
      const errors=[];
      // vehicle name → quoted
      let name = (s.match(/"([^"]+)"/)||[])[0];
      if (!name){
        const nm = s.match(/\b([A-Z][a-zA-Z]+(?:[- ](?:[A-Z0-9][a-zA-Z0-9()\-]+))+)\b/); // rough guess
        name = nm ? `"${nm[1]}"` : 'a car';
      }
      // upgrades order
      const bits=[];
      if (/\b(full\s*config|max\s*config|fully\s*upgraded)\b/i.test(s)) bits.push('with full configuration');
      else if (/\b(partial|nearly max|lvl ?[1-3])\b/i.test(s)) bits.push('with partial configuration');
      if (/\bvisual\b|\bbody kit\b|\bbody upgrades\b/i.test(s)) bits.push('visual upgrades');
      if (/\bluminous (rims|wheels)|unique wheels/i.test(s)) bits.push('luminous wheels');
      if (/\binsurance\b/i.test(s)) bits.push('insurance');
      if (/\bturbo\b/i.test(s)) bits.push('turbo kit');
      if (/\bdrift\b/i.test(s)) bits.push('drift kit');

      let subject = name;
      if (bits.length){
        subject += ' ' + (bits[0].startsWith('with')? bits[0] : 'with '+bits[0]);
        if (bits.length>1) subject += ', ' + bits.slice(1).join(', ');
      }
      subject = addEndPeriod(tcFirst(subject));

      // money
      let label = moneyLabelFor(opener);
      let amtRaw = (s.match(/\b(price|budget|rent)\s*[:\-]?\s*([^.,\n]+(?:Million)?(?:\s*each)?)\b/i) || [,'', ''])[2] || (s.match(/\$(?:\s*)[\d\.\,]+(?:\s*Million)?/i)||[''])[0];
      let mline = '';
      if (label){
        if (!amtRaw || /negotiable/i.test(amtRaw)) mline = `${label}: Negotiable.`;
        else {
          const norm = normalizeMoney(amtRaw);
          const endNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
          mline = `${label}: ${norm}${endNum?'':'.'}`;
        }
      } else if (amtRaw){
        const norm = normalizeMoney(amtRaw);
        const endNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
        mline = `Price: ${norm}${endNum?'':'.'}`;
      }

      return { text: `${opener} ${subject}${mline?' '+mline:''}`, errors };
    }

    function buildBusiness(opener, s){
      const errors=[];
      // name
      let name = BUSINESS_LIST.find(b => lc(s).includes(lc(b))) || 'ATM';
      // number
      let num = (s.match(/\b(?:no\.?|number|num|#|№)\s*(\d+)\b/i)||[])[1];
      let subj = name + (num? ` №${num}` : ' business');
      subj = addEndPeriod(tcFirst(subj));

      // money (> $300 Million → Negotiable)
      let label = moneyLabelFor(opener) || 'Price';
      let amtRaw = (s.match(/\b(price|budget)\s*[:\-]?\s*([^.,\n]+(?:Million)?)\b/i) || [,'',''])[2] || (s.match(/\$(?:\s*)[\d\.\,]+(?:\s*Million)?/i)||[''])[0];
      let mline='';
      if (!amtRaw || /negotiable/i.test(amtRaw)) mline = `${label}: Negotiable.`;
      else {
        let norm = normalizeMoney(amtRaw);
        const over = /\$?(\d+)\s*Million/i.exec(norm);
        if (over && Number(over[1])>300) norm = 'Negotiable';
        const endNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
        mline = `${label}: ${norm}${endNum?'':'.'}`;
      }
      return { text: `${opener} ${subj} ${mline}`.trim(), errors };
    }

    function buildDating(s){
      const errors=[];
      // specific person?
      let personMatch = s.match(/\b([A-Z][a-z]+)\s+([A-Z][a-z]+)\b/);
      let base = 'Looking for ';
      if (personMatch){
        base += `${tcFirst(personMatch[1])} ${tcFirst(personMatch[2])}.`;
      } else {
        // generic phrase
        const phrase = (s.match(/looking\s+for\s+([a-z ]+)/i)||[])[1];
        base += phrase ? phrase.trim().replace(/\.$/, '') + '.' : 'a friend.';
      }
      let out = addEndPeriod(tcFirst(base));
      return { text: out, errors };
    }

    function buildWork(s){
      const errors=[];
      let hiring = /\bhiring\b/i.test(s);
      let role = (s.match(/\bhiring\s+([a-z ]+)/i)||[])[1] || (s.match(/\blooking\s+for\s+work\s+as\s+([a-z ]+)/i)||[])[1] || (s.match(/\b(driver|lawyer|dj|photographer|bodyguard|dancer|professional singer|assistant|trucker|electrician|gardener|surveyor|locksmith)\b/i)||[])[1] || 'workers';
      role = role.trim();
      let subj = hiring ? `Hiring ${role}` : `${tcFirst(role)} looking for work`;

      const site = (s.match(/construction site\s*(?:№|#)?\s*(1|2|3)/i)||[])[1];
      if (site){
        const siteMap = {1:'Vespucci Boulevard',2:'Calais Avenue',3:'Pillbox Hill'};
        subj += ` at Construction site №${site}, ${siteMap[site]}`;
      }
      subj = addEndPeriod(tcFirst(subj));

      let salaryRaw = (s.match(/\b(?:salary|pay|bonus)\s*[:\-]?\s*([^.,\n]+(?:Million)?)\b/i)||[])[1];
      let mline = salaryRaw ? `Salary: ${normalizeMoney(salaryRaw)}` : 'Salary: Negotiable';
      if (!/\.$/.test(mline)) mline = addEndPeriod(mline);

      return { text: `${subj} ${mline}`.trim(), errors };
    }

    function buildOther(opener, s){
      const errors=[];
      // up to 3 items loosely parsed (comma/and separated)
      let itemStr = (s.match(/\b(?:selling|buying)\b\s+(.+)/i)||[])[1] || s;
      let items = itemStr.split(/,| and /i).map(x=>x.replace(/\b(price|budget|rent)\b.*$/i,'').trim()).filter(Boolean);
      if (items.length>3) errors.push('Cannot advertise more than 3 items at a time.');
      if (items.length===0) items = ['items'];

      let subject = `${opener} ` + (items.length===1 ? items[0] : items.join(', ').replace(/,([^,]*)$/,' and$1'));
      subject = addEndPeriod(tcFirst(subject));

      // beach market negotiable rule
      let isBeachMarket = /beach market shop №\d+/i.test(s);

      // money
      let label = moneyLabelFor(opener);
      let amtRaw = (s.match(/\b(price|budget)\s*[:\-]?\s*([^.,\n]+(?:Million)?(?:\s*each)?)\b/i) || [,'',''])[2] || (s.match(/\$(?:\s*)[\d\.\,]+(?:\s*Million)?(?:\s*each)?/i)||[''])[0];
      let mline = '';
      if (label){
        if (!amtRaw || /negotiable/i.test(amtRaw)) mline = `${label}: Negotiable.`;
        else {
          const norm = normalizeMoney(amtRaw);
          const endNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
          mline = `${label: label}: ${norm}${endNum?'':'.'}`;
        }
      } else if (amtRaw){
        const norm = normalizeMoney(amtRaw);
        const endNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
        mline = `Price: ${norm}${endNum?'':'.'}`;
      }
      if (isBeachMarket && /Negotiable\.$/i.test(mline)) mline = '';

      return { text: `${subject}${mline? ' '+mline:''}`, errors };
    }

    // ===== Main Raw Parser =====
    function generateFromRaw(){
      const raw = ($('rawInput').value||'').trim();
      $('finalOutput').value = '';
      $('chips').innerHTML = '';
      $('checks').innerHTML = '';
      $('errors').innerHTML = '';
      if (!raw) return;

      // blacklist
      const bad = containsBlacklist(raw);
      if (bad){ setErrors([`Rejected: contains blacklisted term: ${bad}`]); return; }

      const action = detectAction(raw);
      const category = detectCategory(raw);
      const moneyLabel = moneyLabelFor(action);

      let out='', errs=[];
      const s = raw
        .replace(/looking to buy|looking to purchase/ig,'Buying')
        .replace(/\bbuyyingng\b/ig,'Buying') // typo fix example
        .replace(/\bno\.\b/ig,'№')
        .replace(/\bhouse\s*(?:number|num|#)\s*/ig,'house №')
        .replace(/\bapartment\s*(?:number|num|#)\s*/ig,'apartment №');

      if (category==='Real Estate'){
        const r = buildReal(action, s); out = r.text; errs = r.errors;
      } else if (category==='Auto'){
        const r = buildAuto(action, s); out = r.text; errs = r.errors;
      } else if (category==='Business'){
        const r = buildBusiness(action, s); out = r.text; errs = r.errors;
      } else if (category==='Dating'){
        const r = buildDating(s); out = r.text; errs = r.errors;
      } else if (category==='Work'){
        const r = buildWork(s); out = r.text; errs = r.errors;
      } else {
        const r = buildOther(action, s); out = r.text; errs = r.errors;
      }

      // house no pattern fix like "house no 85"
      out = out.replace(/\bhouse\s+no\s+(\d+)/ig,'house №$1');
      out = out.replace(/\bapartment\s+no\s+(\d+)/ig,'apartment №$1');
      out = out.replace(/\bpenthouse\s+no\s+(\d+)/ig,'penthouse №$1');
      out = out.replace(/\bmansion\s+no\s+(\d+)/ig,'mansion №$1');

      // master money normalization (if someone typed bare number)
      out = out.replace(/\b(Price|Budget|Rent):\s*([^.\n]+)(?!\.)/g, (_,L,val)=>{
        const norm=normalizeMoney(val);
        return `${L}: ${norm}${/\d$/.test(norm)&&!/\bMillion\b/.test(norm)?'':'.'}`;
      });

      // Capitalize and fix places
      out = tcFirst(fixPlaces(out));
      if (!licenseOK(out)) errs.push('License plate must be 3–7 characters in length.');

      $('finalOutput').value = out;
      showChips({category, action, moneyLabel});
      setChecks(out, action);
      setErrors(errs);
    }
  </script>
</body>
</html>
