<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lifeinvader EN-03 — Ad Builder (Form Mode)</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e7e8ea; --muted:#a8acb3; --card:#14161a; --accent:#6aa6ff; --ok:#3ecf8e; --warn:#ffb648; --bad:#ff5a7a; --chip:#1f2329;
    --shadow:0 8px 24px rgba(0,0,0,.25);
  }
  [data-theme="light"]{
    --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --accent:#2563eb; --ok:#10b981; --warn:#d97706; --bad:#e11d48; --chip:#eef2f7;
    --shadow:0 8px 24px rgba(15,23,42,.08);
  }
  html,body{height:100%}
  body{margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,ui-monospace; background:var(--bg); color:var(--fg)}
  .app{max-width:1140px; margin:0 auto; padding:16px}
  header{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .title{font-weight:800; letter-spacing:.2px; font-size:1.05rem}
  .mode{display:flex; align-items:center; gap:8px}
  .toggle{appearance:none; width:52px; height:28px; border-radius:999px; position:relative; background:var(--chip); outline:2px solid transparent; cursor:pointer; box-shadow:var(--shadow)}
  .toggle:before{content:""; position:absolute; width:22px; height:22px; border-radius:50%; top:3px; left:3px; background:var(--fg); transition:transform .2s ease}
  .toggle:checked{background:linear-gradient(90deg,var(--accent),#22d3ee)}
  .toggle:checked:before{transform:translateX(24px)}
  .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:14px}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card); border-radius:16px; padding:14px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.06)}
  label{display:block; font-weight:700; margin-bottom:6px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .muted{color:var(--muted); font-size:.92rem}
  .pill{padding:8px 12px; border-radius:999px; background:var(--chip)}
  .btn{appearance:none; border:0; padding:12px 14px; border-radius:12px; color:#fff; background:var(--accent); font-weight:800; cursor:pointer; box-shadow:var(--shadow)}
  .btn.secondary{background:#7c8596}
  .btn.ghost{background:transparent; color:var(--fg); border:1px dashed rgba(127,127,127,.35)}
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{background:var(--chip); padding:6px 10px; border-radius:999px; font-size:.82rem}
  .chip.ok{background: rgba(16,185,129,.12); color:var(--ok)}
  .chip.bad{background: rgba(225,29,72,.12); color:var(--bad)}
  .output{font-family:ui-monospace,Menlo,Consolas,monospace; background:var(--chip); border-radius:12px; padding:12px; white-space:pre-wrap; word-break:break-word}
  input, select{
    width:100%; border-radius:12px; border:1px solid rgba(127,127,127,.25); background:transparent; color:var(--fg); padding:10px; outline:none
  }
  .grid2{display:grid; gap:10px; grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid3{display:grid; gap:10px; grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:720px){ .grid2,.grid3{grid-template-columns:1fr} }
  fieldset{border:1px dashed rgba(127,127,127,.35); border-radius:12px; padding:10px}
  legend{padding:0 6px; color:var(--muted); font-weight:600}
  .inline{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .small{font-size:.86rem}
  .list{display:grid; gap:10px}
  .ad{border:1px solid rgba(127,127,127,.25); border-radius:14px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), transparent)}
  .ad .hdr{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:6px}
  .ad .cat{font-weight:800; padding:4px 8px; border-radius:8px; background:var(--chip)}
  .ad .text{white-space:pre-wrap}
</style>
</head>
<body data-theme="dark">
<div class="app">
  <header>
    <div class="title">Lifeinvader EN-03 • Form-Based Ad Builder</div>
    <div class="mode">
      <span class="pill small">Day / Night</span>
      <input id="themeToggle" class="toggle" type="checkbox" aria-label="Toggle theme" />
    </div>
  </header>

  <div class="grid">
    <!-- LEFT: FORM BUILDER -->
    <section class="card">
      <label>Create an ad</label>

      <div class="grid3">
        <div>
          <div class="small muted">Category</div>
          <select id="categorySel">
            <option>Real Estate</option>
            <option>Auto</option>
            <option>Businesses</option>
            <option>Work</option>
            <option>Dating</option>
            <option>Discounts</option>
            <option>Services</option>
            <option selected>Other</option>
          </select>
        </div>
        <div>
          <div class="small muted">Action</div>
          <select id="actionSel">
            <option>Selling</option>
            <option>Buying</option>
            <option>Trading</option>
            <option>Selling or trading</option>
            <option>Renting out</option>
          </select>
        </div>
        <div>
          <div class="small muted">Item / Name</div>
          <input id="itemName" placeholder='e.g., "Ubermacht M5 (E34)" or house / pineapple / license plate (1ABC234)'>
        </div>
      </div>

      <div class="grid3" style="margin-top:10px">
        <div>
          <div class="small muted">Quantity (optional)</div>
          <input id="qty" type="number" min="1" placeholder="e.g., 2">
        </div>
        <div>
          <div class="small muted">Money</div>
          <input id="money" placeholder='e.g., 1.7k each, 10 Million, Negotiable'>
        </div>
        <div>
          <div class="small muted">Money label (auto)</div>
          <input id="moneyLabel" disabled value="Price:">
        </div>
      </div>

      <!-- REAL ESTATE FIELDS -->
      <fieldset id="reBlock" style="margin-top:12px; display:none">
        <legend>Real Estate</legend>
        <div class="grid3">
          <div>
            <div class="small muted">Property</div>
            <select id="reType">
              <option>house</option>
              <option>apartment</option>
              <option>penthouse</option>
              <option>mansion</option>
            </select>
          </div>
          <div>
            <div class="small muted">Number (optional)</div>
            <input id="reNum" placeholder="e.g., 758">
          </div>
          <div>
            <div class="small muted">Location (optional)</div>
            <input id="reLoc" placeholder="e.g., Vinewood Hills">
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div class="inline">
            <label class="small"><input type="checkbox" id="reGarden"> Garden</label>
            <label class="small"><input type="checkbox" id="reCustom"> Custom interior</label>
            <label class="small"><input type="checkbox" id="reIns"> Insurance</label>
            <label class="small"><input type="checkbox" id="reHeli"> Helipad</label>
          </div>
          <div class="grid3">
            <div>
              <div class="small muted">Garage (g.s.)</div>
              <select id="reGS">
                <option value="">—</option>
                <option>2 g.s.</option>
                <option>5 g.s.</option>
                <option>9 g.s.</option>
                <option>25 g.s.</option>
              </select>
            </div>
            <div>
              <div class="small muted">Warehouses (w.h.)</div>
              <input id="reWH" type="number" min="1" placeholder="e.g., 3">
            </div>
            <div>
              <div class="small muted">Views/Other</div>
              <input id="reOther" placeholder="e.g., swimming pool, nice views">
            </div>
          </div>
        </div>
      </fieldset>

      <!-- AUTO FIELDS -->
      <fieldset id="autoBlock" style="margin-top:12px; display:none">
        <legend>Auto</legend>
        <div class="grid2">
          <div>
            <div class="small muted">Configuration</div>
            <select id="autoCfg">
              <option value="">None</option>
              <option>with partial configuration</option>
              <option>with full configuration</option>
            </select>
          </div>
          <div class="inline" style="align-items:flex-end">
            <label class="small"><input type="checkbox" id="autoVisual"> visual upgrades</label>
            <label class="small"><input type="checkbox" id="autoLuminous"> luminous wheels</label>
            <label class="small"><input type="checkbox" id="autoIns"> insurance</label>
            <label class="small"><input type="checkbox" id="autoTurbo"> turbo kit</label>
            <label class="small"><input type="checkbox" id="autoDrift"> drift kit</label>
          </div>
        </div>
        <div class="small muted" style="margin-top:6px">Tip: Vehicle brand/model should be in quotes. Example: <b>"Ubermacht M5 (E34)"</b></div>
      </fieldset>

      <!-- WORK/DATING HINTS -->
      <div id="datingHint" class="small muted" style="margin-top:8px; display:none">
        Dating: use <b>Looking for Firstname Lastname</b> or allowed phrases. Don’t include Price/Budget.
      </div>
      <div id="workHint" class="small muted" style="margin-top:8px; display:none">
        Work: use “Hiring …” or “Looking for work …”. Replace “level” with “years experience”.
      </div>

      <div class="row" style="margin-top:10px">
        <button id="genBtn" class="btn">Generate formatted ad</button>
        <button id="addBtn" class="btn secondary">Add to list</button>
        <button id="clearBtn" class="btn ghost">Clear</button>
      </div>

      <div id="alerts" style="margin-top:8px"></div>

      <div style="margin-top:12px">
        <label>Formatted output</label>
        <div id="out" class="output" role="status" aria-live="polite"></div>
        <div class="row" style="margin-top:8px">
          <button id="copyBtn" class="btn ghost small">Copy output</button>
        </div>
      </div>
    </section>

    <!-- RIGHT: META + LIST -->
    <aside class="card">
      <label>Detected category</label>
      <div id="categoryChip" class="chips"><span class="chip">—</span></div>

      <label style="margin-top:8px">Checks</label>
      <div id="checks" class="chips"></div>

      <div class="row" style="margin-top:12px; justify-content:space-between">
        <div class="inline">
          <input id="search" placeholder="Search ads…" style="width:220px">
          <button id="searchBtn" class="btn">Search</button>
        </div>
        <button id="exportBtn" class="btn ghost small">Export JSON</button>
      </div>

      <div class="warning" style="margin-top:12px">
        Blacklist enforced (firearms, drugs, covid masks, scanners, balaclavas, etc.). Rejections include: multi-vehicle ads, >3 items in Other, improper ad, template not found, missing rental period, etc.
      </div>
    </aside>
  </div>

  <section class="card" style="margin-top:14px">
    <div class="row" style="justify-content:space-between; align-items:center">
      <label>Generated ads</label>
    </div>
    <div id="list" class="list"></div>
  </section>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const els = {
    theme: $('themeToggle'),
    categorySel: $('categorySel'),
    actionSel: $('actionSel'),
    itemName: $('itemName'),
    qty: $('qty'),
    money: $('money'),
    moneyLabel: $('moneyLabel'),
    reBlock: $('reBlock'), reType: $('reType'), reNum: $('reNum'), reLoc: $('reLoc'),
    reGarden: $('reGarden'), reCustom: $('reCustom'), reIns: $('reIns'), reHeli: $('reHeli'),
    reGS: $('reGS'), reWH: $('reWH'), reOther: $('reOther'),
    autoBlock: $('autoBlock'), autoCfg: $('autoCfg'), autoVisual: $('autoVisual'),
    autoLuminous: $('autoLuminous'), autoIns: $('autoIns'), autoTurbo: $('autoTurbo'), autoDrift: $('autoDrift'),
    datingHint: $('datingHint'), workHint: $('workHint'),
    genBtn: $('genBtn'), addBtn: $('addBtn'), clearBtn: $('clearBtn'),
    out: $('out'), alerts: $('alerts'), categoryChip: $('categoryChip'), checks: $('checks'),
    search: $('search'), searchBtn: $('searchBtn'), exportBtn: $('exportBtn'), list: $('list'),
    copyBtn: $('copyBtn'),
  };

  // Theme
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  els.theme.checked = savedTheme === 'light';
  els.theme.addEventListener('change', () => {
    const val = els.theme.checked ? 'light' : 'dark';
    document.body.setAttribute('data-theme', val);
    localStorage.setItem('theme', val);
  });

  // Helpers
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c]));
  const titleCaseFirst = s => s ? s[0].toUpperCase()+s.slice(1) : s;
  const lc = s => (s||'').toLowerCase();
  const dotsThousands = n => String(Math.trunc(Math.abs(Number(n)))).replace(/\B(?=(\d{3})+(?!\d))/g,'.');

  function normalizeMoney(str){
    if (!str) return '';
    return String(str)
      .replace(/\$?\s*([\d.,]+)\s*([kKmM])\b/g, (_, num, suf) => {
        const val = parseFloat(String(num).replace(/,/g,'.'));
        if (!isFinite(val)) return `$${num}`;
        if (suf.toLowerCase()==='k') return `$${dotsThousands(Math.round(val*1000))}`;
        return `$${val % 1 === 0 ? val.toFixed(0) : String(val)} Million`;
      })
      .replace(/\$?\s*(\d{1,3}(?:[,.]\d{3})+|\d+)(?!\s*Million)\b/g, (_,num)=>{
        const clean = String(num).replace(/,/g,'');
        if (!/^\d+(\.\d+)?$/.test(clean)) return `$${num}`;
        return `$${dotsThousands(clean)}`;
      })
      .replace(/\bnegotiable\b/gi,'Negotiable');
  }

  // Blacklist (key terms)
  const BLACKLIST = new Set([
    'firearm','firearms','gun','guns','weapon','weapons','pistol','rifle','shotgun','ammo','ammunition',
    'bulletproof vest','bulletproof vests','armor plates','armor plate','armor',
    'weed','cannabis','cannabis seeds','weed seeds','drug','drugs','cocaine',
    'ems surgical mask','surgical mask','medical mask','covid mask','ems mask',
    'vehicle scanner','human scanner','resource scanner','scanner','radar','anti-radar',
    'balaclava','balaclava mask','bandit mask',
    'rope','ropes','head bag','head bags',
    'usb with virus',
    'lock pick','lock picks','lockpick','lockpicks','crowbar','crowbars',
    'animal skin','satellite dish','barricade','engine block','air horn'
  ]);

  // Category detection
  const CATS = {
    "Real Estate": ['house','apartment','penthouse','mansion','g.s.','w.h.','helipad','garden','view','vinewood','mirror park','lifeinvader'],
    "Auto": ['"','vehicle','car ','truck','motorcycle','bike','atv','boat','helicopter','plane','monowheel','drift kit','turbo kit','configuration','luminous wheels','auto fair'],
    "Businesses": ['ammunition store','bar','car wash','chip tuning','clothing shop','cowshed','electric station','farm','flower shop','freight train','gas station','hair salon','jewelry store','oil well','parking','plantation','car sharing','state object','service station','24/7 store','tattoo studio','taxi company','atm','juice shop','burger shop','warehouse'],
    "Work": ['hiring','looking for work','looking for a job','salary','awarding','driver','lawyer','dj','photographer','bodyguard','assistant','professional dancer','professional singer','trucker','construction site'],
    "Dating": ['looking for '],
    "Discounts": ['% discount','% off','offering','discount '],
    "Services": ['happy hour','template','join us','office'],
    "Other": ['party','dice','fish','fishing rod','fruits','vegetables','mask','video card','repair kit','token','thread','snow','ticket','license plate','pickaxe','tuning','elixir','pet','container','battery','fuel','wires','prime','prime platinum','sim card','lottery','miner','inventory','backpack skin','tonic','pearl','statue','drawing','mushroom','paint can','timber','scrap metal','top quality metal','leash','hookah','charger','milk','luminous wheels of type']
  };
  const detectCategory = text => {
    const s = lc(text);
    for (const [k, arr] of Object.entries(CATS)){
      if (arr.some(w => s.includes(w))) return k;
    }
    return 'Other';
  };

  // Official/unofficial place casing
  const OFFICIAL = ['Vinewood Hills','Rockford Hills','Richman','Sandy Shores','Paleto Bay','Postal','Hospital','Capitol','Fire Station','Auto Fair','Bahama Mamas Bar','Tequi-la-la Bar','FIB','Hotel Spa Bar','Pacific Bluffs Country Club','Diamond Resort Bar','Vanilla Unicorn Bar','Church','Stock Exchange','Stadium','Chumash','Lifeinvader','Del Perro Pier','Del Perro Beach','Cayo Perico Island','Hotel','Raton Canyon','School','SAHP'];
  const UNOFFICIAL = ['airport','autosalon','beach','beach market','ghetto','post office','train station','yacht'];
  function fixPlaceCase(text){
    OFFICIAL.forEach(p=>{ text = text.replace(new RegExp(p.replace(/[()]/g,'\\$&'), 'ig'), p); });
    UNOFFICIAL.forEach(p=>{ text = text.replace(new RegExp(`\\b${p}\\b`,'ig'), p.toLowerCase()); });
    return text;
  }

  // Real Estate builders
  function buildRealEstateObject(){
    const t = els.reType.value; // house/apartment/...
    const num = (els.reNum.value||'').trim();
    const loc = (els.reLoc.value||'').trim();
    let obj = t;
    if (num) obj += ` №${num}`;
    else obj = (/^[aeiou]/i.test(t)?'an ':'a ') + obj;
    const feats = [];
    if (els.reGarden.checked) feats.push('a garden');
    if (els.reGS.value) feats.push(els.reGS.value);
    if (els.reWH.value) feats.push(`${els.reWH.value} w.h.`);
    if (els.reCustom.checked) feats.push('custom interior');
    if (els.reIns.checked) feats.push('insurance');
    if (els.reHeli.checked) feats.push('helipad');
    if (els.reOther.value.trim()){
      // split commas, normalize phrasing
      els.reOther.value.split(',').map(s=>s.trim()).filter(Boolean).forEach(x=>feats.push(x));
    }
    if (feats.length){
      const tail = feats.length===1 ? feats[0] : feats.slice(0,-1).join(', ') + ' and ' + feats.slice(-1);
      obj += ` with ${tail}`;
    }
    if (loc) obj += ` in ${loc}`;
    return obj;
  }

  // Auto builders
  function buildAutoTail(){
    const bits = [];
    if (els.autoCfg.value) bits.push(els.autoCfg.value);
    if (els.autoVisual.checked) bits.push('visual upgrades');
    if (els.autoLuminous.checked) bits.push('luminous wheels');
    if (els.autoIns.checked) bits.push('insurance');
    if (els.autoTurbo.checked) bits.push('turbo kit');
    if (els.autoDrift.checked) bits.push('drift kit');
    if (!bits.length) return '';
    return ' ' + (bits[0].startsWith('with')? bits[0] : 'with '+bits[0]) + (bits.slice(1).length? ', '+bits.slice(1).join(', ') : '');
  }

  // License plate quick check
  function validLicensePlate(s){
    const m = /\blicense plate\s*\(([^)]+)\)/i.exec(s||'');
    if (!m) return true;
    const val = m[1].trim();
    return val.length>=3 && val.length<=7;
  }

  // Money label auto
  function updateMoneyLabel(){
    const act = els.actionSel.value;
    if (act==='Buying') els.moneyLabel.value = 'Budget:';
    else if (act==='Renting out') els.moneyLabel.value = 'Rent:';
    else if (act==='Trading') els.moneyLabel.value = ''; // optional
    else els.moneyLabel.value = 'Price:';
  }

  // Show/hide blocks based on category
  function updateBlocks(){
    const cat = els.categorySel.value;
    els.reBlock.style.display = (cat==='Real Estate') ? '' : 'none';
    els.autoBlock.style.display = (cat==='Auto') ? '' : 'none';
    els.datingHint.style.display = (cat==='Dating') ? '' : 'none';
    els.workHint.style.display = (cat==='Work') ? '' : 'none';
  }

  // Build ad from form fields
  function buildAd(){
    // Blacklist from item name
    const raw = [els.itemName.value, els.reOther.value, els.reLoc.value].join(' ').toLowerCase();
    for (const bad of BLACKLIST){ if (raw.includes(bad)) return {formatted:'', category:'—', problems:[{type:'error', msg:`Rejected: contains blacklisted term: ${bad}`}]}; }

    const cat = els.categorySel.value;
    let action = els.actionSel.value;
    let name = (els.itemName.value||'').trim();

    // Real Estate object builder overrides "name"
    if (cat==='Real Estate'){
      name = buildRealEstateObject();
      // apartments cannot be “with insurance”
      if (/apartment №\d+.*insurance/i.test(name)){
        return {formatted:'', category:cat, problems:[{type:'error', msg:'Apartments cannot be insured.'}]};
      }
    }

    // Auto: ensure quotes around brand model if looks like a vehicle name
    if (cat==='Auto' && name && !/^".*"$/.test(name) && /\b[A-Za-z]+\s+[A-Za-z0-9]/.test(name)){
      name = `"${name}"`;
    }
    if (cat==='Auto') {
      name = name + buildAutoTail();
    }

    // If user chose Real Estate but left number empty, we already added article “a/an”
    // If chose Real Estate with number, we already formatted as №N

    // Quantity prefix
    const qty = Number(els.qty.value||'');
    let subject = action;
    if (qty && qty>1 && cat!=='Real Estate') {
      // pluralize crudely by adding "s" (policy examples accept “Selling 2 Drawings.”, “Selling 10 batteries.”)
      subject += ' ' + qty + ' ' + (name.replace(/^a |an /i,'').trim());
    } else {
      subject += ' ' + name;
    }
    subject = subject.replace(/\s+\.$/,'').trim();
    subject = titleCaseFirst(subject);
    if (!/\d$/.test(subject)) subject = subject.replace(/\.*$/,'') + '.';

    // Money line
    let moneyRaw = (els.money.value||'').trim();
    let mlabel = els.moneyLabel.value;
    let mline = '';
    if (mlabel){ // Price/Budget/Rent
      if (!moneyRaw || /negotiable/i.test(moneyRaw)) mline = `${mlabel} Negotiable.`;
      else {
        const norm = normalizeMoney(moneyRaw);
        // if ends with pure number, omit final dot
        const endsNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
        mline = `${mlabel} ${norm}${endsNum?'':'.'}`;
      }
    } else {
      // Trading: optional. If provided, normalize with "Price:" by policy examples (can include “Price: Negotiable.”)
      if (moneyRaw){
        const norm = normalizeMoney(moneyRaw);
        const endsNum = /\d$/.test(norm) && !/\bMillion\b/.test(norm);
        mline = `Price: ${norm}${endsNum?'':'.'}`;
      }
    }

    // Special policy bits
    // “Casino apartment” -> “Casino penthouse” already not selectable; but if typed in itemName:
    subject = subject.replace(/\bCasino apartment\b/ig,'Casino penthouse');

    // Official/unofficial places casing
    subject = fixPlaceCase(subject);

    // House № rule already handled; also add “a/an” if no number already handled by builder

    // License plate length (if present)
    const preview = [subject, mline].filter(Boolean).join(' ').trim();
    const problems = [];
    if (!validLicensePlate(preview)){
      problems.push({type:'error', msg:'License plate must be 3–7 characters in length.'});
    }

    // Category detection from final preview
    const detected = detectCategory(preview);

    // Auto: one vehicle per ad unless trading — we only allow one name field in the form, so we’re safe.

    // Work tweaks: replace “level” with “years experience”
    if (cat==='Work'){
      subject = subject.replace(/\blevel\b/ig,'years experience');
    }

    // Beach market negotiable line: if subject mentions “at the beach market shop №”, negotiable line can be omitted
    if (/beach market shop №\d+/i.test(preview) && /Negotiable\.$/.test(mline)) {
      mline = '';
    }

    const formatted = [subject, mline].filter(Boolean).join(' ').trim();
    return {formatted, category: detected, problems};
  }

  // Checks UI
  function renderChecks({formatted, action}){
    const wrap = els.checks; wrap.innerHTML='';
    const add=(t,cls='')=>{ const s=document.createElement('span'); s.className='chip '+cls; s.textContent=t; wrap.appendChild(s); };
    /^[A-Z]/.test(formatted) ? add('Capitalization ✓','ok') : add('Capitalization ✕','bad');
    if (action==='Buying' && /Budget:/.test(formatted)) add('Buyer→Budget ✓','ok');
    else if ((action==='Selling'||action==='Selling or trading') && /Price:/.test(formatted)) add('Seller→Price ✓','ok');
    else if (action==='Renting out' && /Rent:/.test(formatted)) add('Rent ✓','ok');
    else if (action==='Trading' && !/Price:|Budget:/.test(formatted)) add('Trading money (optional) ✓','ok');
    else add('Money label ✕','bad');
    /(?:house|apartment|penthouse|mansion) №\d+/i.test(formatted) ? add('№ format ✓','ok') : add('№ format —');
    /(\.|\d)$/.test(formatted.trim()) ? add('End punctuation ✓','ok') : add('End punctuation ✕','bad');
  }

  // List & search
  const ADS = [];
  function refreshList(q=''){
    const needle = lc(q.trim());
    els.list.innerHTML='';
    ADS.filter(i => !needle || lc(i.text).includes(needle) || lc(i.category).includes(needle)).forEach(i=>{
      const div = document.createElement('div');
      div.className='ad';
      div.innerHTML = `
        <div class="hdr">
          <div class="cat">${escapeHtml(i.category)}</div>
          <div class="muted small">${new Date(i.id).toLocaleString()}</div>
        </div>
        <div class="text">${escapeHtml(i.text)}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn ghost small" data-copy="${i.id}">Copy</button>
          <button class="btn ghost small" data-del="${i.id}">Delete</button>
        </div>
      `;
      els.list.appendChild(div);
    });
    els.list.querySelectorAll('button[data-copy]').forEach(b=>{
      b.addEventListener('click',()=>{
        const id = Number(b.getAttribute('data-copy'));
        const item = ADS.find(x=>x.id===id);
        navigator.clipboard.writeText(item.text);
        b.textContent='Copied ✓'; setTimeout(()=>b.textContent='Copy',900);
      });
    });
    els.list.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click',()=>{
        const id = Number(b.getAttribute('data-del'));
        const idx = ADS.findIndex(x=>x.id===id);
        if (idx>=0){ ADS.splice(idx,1); refreshList(els.search.value); }
      });
    });
  }

  // Events
  els.categorySel.addEventListener('change', updateBlocks);
  els.actionSel.addEventListener('change', updateMoneyLabel);
  updateBlocks(); updateMoneyLabel();

  els.genBtn.addEventListener('click', ()=>{
    const res = buildAd();
    els.out.textContent = res.formatted;
    els.categoryChip.innerHTML = `<span class="chip">${res.category}</span>`;
    renderProblems(res.problems);
    renderChecks({formatted:res.formatted, action:els.actionSel.value});
  });

  els.addBtn.addEventListener('click', ()=>{
    const text = els.out.textContent.trim(); if(!text) return;
    ADS.push({id:Date.now(), text, category:detectCategory(text)});
    refreshList();
    els.alerts.innerHTML = `<div class="success">Added to list.</div>`; setTimeout(()=>els.alerts.innerHTML='',1200);
    els.out.textContent='';
  });

  els.clearBtn.addEventListener('click', ()=>{
    ['itemName','qty','money','reNum','reLoc','reWH','reOther'].forEach(id=> $(id).value='');
    ['reGarden','reCustom','reIns','reHeli','autoVisual','autoLuminous','autoIns','autoTurbo','autoDrift'].forEach(id=> $(id).checked=false);
    els.out.textContent=''; els.alerts.innerHTML='';
  });

  els.searchBtn.addEventListener('click', ()=> refreshList(els.search.value));
  els.search.addEventListener('keydown', e=>{ if(e.key==='Enter') els.searchBtn.click(); });

  els.exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(ADS,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='ads.json'; a.click(); URL.revokeObjectURL(url);
  });

  els.copyBtn.addEventListener('click', ()=>{
    const t = els.out.textContent.trim(); if(!t) return;
    navigator.clipboard.writeText(t); els.copyBtn.textContent='Copied ✓'; setTimeout(()=>els.copyBtn.textContent='Copy output',900);
  });

  function renderProblems(problems){
    els.alerts.innerHTML='';
    problems.forEach(p=>{
      const div = document.createElement('div');
      div.className = p.type==='error' ? 'error' : 'warning';
      div.style.cssText='border-left:4px solid '+(p.type==='error'?'var(--bad)':'var(--warn)')+'; padding:8px 10px; background:'+(p.type==='error'?'rgba(225,29,72,.12)':'rgba(217,119,6,.12)')+'; border-radius:10px; margin-top:8px';
      div.textContent = p.msg;
      els.alerts.appendChild(div);
    });
  }

  // Demo: quick example for your earlier test
  els.categorySel.value='Real Estate'; updateBlocks();
  els.actionSel.value='Selling'; updateMoneyLabel();
  els.reType.value='house'; els.reNum.value='85'; els.itemName.value=''; els.money.value='Negotiable';
  els.genBtn.click(); // => Selling house №85. Price: Negotiable.
})();
</script>
</body>
</html>
