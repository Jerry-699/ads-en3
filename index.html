<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lifeinvader Ads — EN-03 (Auto-Detect + Manual Fix)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0e1320;--card:#11182a;--muted:#99a3b3;--fg:#e8eefc;--brand:#6aa5ff;--ok:#1dd1a1;--line:#1f2940}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 Inter,system-ui}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px} h1{font-size:22px;margin:0 0 14px}
  .hint{color:var(--muted);font-size:13px} .card{background:#11182a;border:1px solid var(--line);border-radius:14px;padding:16px;margin:18px 0}
  textarea,input,select{width:100%;background:#0c1120;border:1px solid var(--line);color:var(--fg);padding:12px;border-radius:10px;outline:none}
  textarea{min-height:140px;resize:vertical} .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .row-3{display:grid;grid-template-columns:1.1fr .7fr .6fr;gap:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;border:none;background:var(--brand);color:#081022;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:#1b253d;color:var(--fg)} .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--fg)}
  .btn.ok{background:var(--ok);color:#04180f} .pill{display:inline-flex;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;margin:6px 6px 0 0;font-size:12px;color:#99a3b3}
  .output{font-weight:600} .mini{font-size:12px;color:#99a3b3} .stack{display:flex;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<div class="wrap">
  <h1>⚡ Auto-Detect (Raw Ad) + Manual Fix</h1>
  <p class="hint">Large rule catalog loads from <code>catalog.json</code>. If it’s missing, a safe fallback is used so the app still works.</p>

  <div class="card">
    <label class="mini">Raw ad text</label>
    <textarea id="raw" placeholder='e.g., "selling level 3 pickaxe price 20k"'></textarea>
    <div class="stack" style="margin-top:10px">
      <button id="gen" class="btn" disabled>Generate</button>
      <button id="clear" class="btn secondary" disabled>Clear</button>
    </div>

    <div class="stack" style="margin-top:14px">
      <input id="out" class="output" readonly placeholder="Your formatted ad will appear here…" />
      <button id="copy" class="btn ghost" disabled>Copy</button>
    </div>
    <div id="flags" class="stack"></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 6px">Manual Fix (optional)</h3>
    <p class="hint">Auto-filled from detection. Edit and Apply. “Apply & Save” stores a local rule so similar raw ads get fixed before parsing.</p>

    <div class="row-3">
      <div><label class="mini">Opener</label>
        <select id="mfOpener" disabled>
          <option>Auto (detected)</option><option>Selling</option><option>Buying</option>
          <option>Trading</option><option>Selling or trading</option><option>Renting out</option><option>Renting</option>
        </select>
      </div>
      <div><label class="mini">Money label</label>
        <select id="mfLabel" disabled>
          <option>Auto (detected)</option><option>Price</option><option>Budget</option><option>Rent</option>
        </select>
      </div>
      <div><label class="mini">Amount</label>
        <input id="mfAmount" placeholder="e.g., 20k, 1.7k each, 1.5m, Negotiable" disabled />
        <div class="mini">k/m shorthands: 20k→$20.000, 1.5k→$1.500, 50m→$50 Million.</div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label class="mini">Subject (edit main sentence)</label>
      <input id="mfSubject" placeholder='e.g., high quality pickaxe; "Obey R8" with full configuration…; house №85 with 5 g.s. and 3 w.h.; etc.' disabled />
    </div>

    <div class="stack" style="margin-top:14px">
      <button id="apply" class="btn" disabled>Apply</button>
      <button id="applySave" class="btn ok" disabled>Apply &amp; Save</button>
      <label class="mini" style="margin-left:6px"><input type="checkbox" id="autoRules" checked disabled /> Auto-apply rules</label>
      <span id="rulesBox" class="mini"></span>
    </div>
  </div>

  <p class="hint">Opener→Money: Buying→Budget, Selling→Price, Renting out→Rent, Renting→Budget. Level→quality (1–4 → low/medium/high/max). Dot-thousands + “Million” formatting. Blacklist enforced.</p>
</div>

<script>
const $=s=>document.querySelector(s);
const enableUI=(on)=> {
  for(const id of ['gen','clear','copy','mfOpener','mfLabel','mfAmount','mfSubject','apply','applySave','autoRules']){
    const el=$('#'+id); if(el) el.disabled=!on;
  }
};
const cap=s=>s? s.charAt(0).toUpperCase()+s.slice(1):s;
const trim=s=>s.replace(/\s+/g,' ').trim();
const RULES_KEY='li_en3_rules_v2';

let CAT=null;

// Fallback catalog (used only if fetch fails)
const FALLBACK = {
  "blacklist": ["firearms?","ammo|ammunition","drugs?","lock ?pick","crowbar","balaclava"],
  "levels": {"1":"low quality","2":"medium quality","3":"high quality","4":"max quality"},
  "openers":[["^(?:looking\\s*to\\s*buy|looking\\s*to\\s*purchase|ltb)\\b","Buying"],["^(?:selling\\s*or\\s*trading|s\\/t)\\b","Selling or trading"],["\\bbuying\\b","Buying"],["\\bselling\\b","Selling"],["\\btrading\\b","Trading"],["\\brenting out\\b","Renting out"],["\\brenting\\b","Renting"]],
  "moneyByOpener":{"Buying":"Budget","Selling":"Price","Trading":"Price","Selling or trading":"Price","Renting out":"Rent","Renting":"Budget"},
  "normalizeRegex": [
    ["max config|max tuning|fully upgraded","with full configuration"],
    ["nearly max|part\\s*l?v?l?3?|lvl3?","with partial configuration"],
    ["body upgrades|body kit","visual upgrades"],
    ["\\bturbo\\b","turbo kit"],
    ["drift (tuning|assistance)?","drift kit"],
    ["luminous (rims|unique wheels?)|unique wheels","luminous wheels"],
    ["extras?","of type"],
    ["casino apartment","Casino penthouse"],
    ["personal business","private business"],
    ["looking to buy|looking to purchase","Buying"]
  ],
  "autoFeatures":["with full configuration","with partial configuration","visual upgrades","luminous wheels","insurance","turbo kit","drift kit"],
  "reFeatures":["a garden","2 g.s.","5 g.s.","9 g.s.","25 g.s.","3 w.h.","4 w.h.","5 w.h.","custom interior","insurance","helipad","swimming pool","tennis court","long driveway","spacious backyard","nice views","beautiful views","great views"],
  "categories":{
    "Real Estate":["house","apartment","penthouse","mansion","casino penthouse"],
    "Auto":["car","truck","motorcycle","bike","atv","boat","helicopter","plane","monowheel","license plate"],
    "Business":["ammunition store","bar","car wash","chip tuning","clothing shop","cowshed","electric station","farm","flower shop","freight train","gas station","hair salon","jewelry store","oil well","parking","plantation","car sharing","state object","service station","24/7 store","tattoo studio","taxi company","atm","juice shop","burger shop","warehouse","fight club"],
    "Work":["hiring","looking for work","job","construction site","driver","lawyer","dj","photographer","bodyguard","assistant","trucker","professional dancer","professional singer"],
    "Dating":["looking for","boyfriend","girlfriend","family","valentine","friends","casino poker players"],
    "Discounts":["discount %","% discount","% off"],
    "Services":["happy hour","template","join","offering","service"]
  },
  "otherSubjects":["pickaxe","fishing rod","inventory","battery","charger","repair kit","video card","wires","timber","thread","snow","token","tonic treat","elixir for a pet","leash","luminous wheels","paint can","pearl","pet food","dice","grand ticket","rare lottery ticket","regular lottery ticket","flame and water lottery ticket","cayo perico ticket","car ticket","secret ticket","secret ticket fragment","pineapple fruits","mandarin fruits","strawberry fruits","cabbage vegetables","mushroom seeds","milk","perch","carp","salmon","trout","valuable container","racer container","wheels 1 container","wheels 2 container","wheels 3 container","ingrand container","progen container","organization container","valentine 2025 container","cage with a pet","cage with a Border Collie","cage with a Cougar","cage with a Cyberdog","cage with a Panda","six tailed fox on shoulder pet","hamster on shoulder pet","toothless dragon on shoulder pet","black voron on shoulder pet","solar barrel","gasoline barrel","kerosene barrel"]
};

async function loadCatalog(){
  try{
    const res=await fetch('catalog.json', {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    CAT=await res.json();
    console.info('catalog.json loaded');
  }catch(e){
    console.warn('catalog.json failed, using fallback:', e);
    CAT=FALLBACK;
  }finally{
    enableUI(true);
    showRules();
  }
}

function saveRules(r){ localStorage.setItem(RULES_KEY, JSON.stringify(r)); }
function loadRules(){ try{return JSON.parse(localStorage.getItem(RULES_KEY)||'[]')}catch{return[]} }
function showRules(){ const r=loadRules(); $('#rulesBox').textContent=r.length?`${r.length} rule(s) saved.`:'No rules saved yet.'; }
function badge(t){ const b=document.createElement('span'); b.className='pill'; b.textContent=t; $('#flags').appendChild(b); }
function formatDots(n){return String(n).replace(/\B(?=(\d{3})+(?!\d))/g,'.');}

function parseMoney(raw){
  if(!raw) return null;
  let s=raw.toLowerCase();
  let m=s.match(/(\$?\s*\d+(?:[\.,]\d+)?\s*(?:k|m)?)(?:\s*each)?/i);
  if(!m) return null;
  let token=m[1].replace(/\s+/g,''); let each=/each/i.test(raw);
  let isM=/m$/i.test(token), isK=/k$/i.test(token);
  token=token.replace(/[km]$/i,'').replace(/\$/g,'').replace(/,/g,'.');
  let num=parseFloat(token); if(isNaN(num)) return null;
  if(isM) return {text:`$${num} Million`, each};
  if(isK) num*=1000;
  return {text:`$${formatDots(Math.round(num))}`, each};
}

function mapLevelsToQuality(t){
  return t.replace(/\b(lvl|level)\s*(1|2|3|4)\b/gi,(_,__,d)=>CAT.levels[d]||_);
}
function normalize(t){
  t=' '+t+' ';
  for(const [re,rep] of CAT.normalizeRegex){ t=t.replace(new RegExp(re,'gi'),' '+rep+' '); }
  t=mapLevelsToQuality(t);
  return trim(t);
}
function openerOf(t){
  for(const [re,label] of CAT.openers){ if(new RegExp(re,'i').test(t)) return label; }
  if(/\bbudget\b/i.test(t)) return 'Buying';
  if(/\bprice|sell\b/i.test(t)) return 'Selling';
  return 'Selling';
}
function moneyLabel(opener){ return CAT.moneyByOpener[opener]||'Price'; }
function detectCategory(t){
  const low=t.toLowerCase();
  for(const [cat,words] of Object.entries(CAT.categories)){
    for(const w of words){ if(new RegExp(`\\b${w.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')}\\b`,'i').test(low)) return cat; }
  }
  if(/^looking\s+for\b/i.test(t)) return 'Dating';
  return 'Other';
}
function extractSubject(t,cat){
  let qm=t.match(/"([^"]+)"/); if(qm) return `"${qm[1]}"`;
  if(cat==='Real Estate'){
    if(/casino\s+apartment/i.test(t)) return 'Casino penthouse';
    const m=t.match(/\b(house|apartment|penthouse|mansion)\s*№?\s*([0-9\-]+)/i);
    if(m) return `${m[1]} №${m[2]}`;
    const m2=t.match(/\bhouse\b|\bapartment\b|\bpenthouse\b|\bmansion\b/i);
    if(m2) return (m2[0].toLowerCase()==='apartment'?'an':'a')+' '+m2[0].toLowerCase();
  }
  if(cat==='Auto'){
    if(/\bmonowheel\b/i.test(t)){ const typ=t.match(/\btype\s*(\d+)\b/i); return typ?`"Monowheel" of type ${typ[1]}`:`"Monowheel"`; }
    if(/\b(helicopter|plane|boat)\b/i.test(t)) return `a ${RegExp.$1}`;
    return 'a car';
  }
  if(cat==='Business'){
    for(const b of CAT.categories.Business){ if(new RegExp(`\\b${b}\\b`,'i').test(t)){ const n=t.match(/№\s*([0-9\-]+)/i)||t.match(/\bno\.?\s*([0-9\-]+)/i); return n?`${b} №${n[1]}`:`${b} business`; } }
    return 'private business';
  }
  if(cat==='Dating'){
    const nm=t.match(/\b([A-Z][a-z]+)\s+([A-Z][a-z]+)\b/); if(nm) return `Looking for ${nm[1]} ${nm[2]}`;
    if(/\bfamily members?\b/i.test(t)) return 'Looking for family members';
    if(/\bfamily\b/i.test(t)) return 'Looking for a family';
    if(/\bboyfriend(s)?\b/i.test(t)) return 'Looking for a boyfriend';
    if(/\bgirlfriend(s)?\b/i.test(t)) return 'Looking for a girlfriend';
    return 'Looking for a person';
  }
  for(const w of CAT.otherSubjects){ if(new RegExp(`\\b${w}\\b`,'i').test(t)) return w; }
  const op=openerOf(t);
  let after=t.replace(new RegExp(`^\\s*${op}\\b\\s*`,'i'),''); after=after.replace(/\b(price|budget|rent).*/i,'').trim();
  return after || 'item';
}
function compose(opener, subject, cat, label, moneyObj){
  let subj=subject.replace(/\b(low|medium|high|max) quality\b/g,(m)=>m.charAt(0).toUpperCase()+m.slice(1));
  if(cat==='Auto'){
    const order=CAT.autoFeatures; let buf=subj, picked=[];
    for(const f of order){ const r=new RegExp(`\\b${f}\\b`,'i'); if(r.test(buf)){ picked.push(f); buf=buf.replace(r,''); } }
    subj=trim(buf); if(picked.length){ subj = `${subj}, ${picked.join(', ').replace(', drift kit',' and drift kit')}`; }
  }
  if(cat==='Real Estate'){
    const order=CAT.reFeatures; let buf=subj, picked=[];
    for(const f of order){ const r=new RegExp(`\\b${f}\\b`,'i'); if(r.test(buf)){ picked.push(f); buf=buf.replace(r,''); } }
    subj=trim(buf); if(picked.length){ const last=picked.pop(); subj=`${subj} with ${picked.join(', ')}${picked.length?', ':''}${picked.length?'and ':''}${last}`.replace('with  ,','with '); }
  }
  const lab=label||moneyLabel(opener);
  let money='Negotiable'; if(moneyObj && moneyObj.text) money=moneyObj.text+(moneyObj.each?' each':'');
  let sent=`${opener} ${cap(subj)}. ${lab}: ${money}`;
  if(/\d$/.test(money)) sent=sent.replace(/\.\s*$/,'');
  return trim(sent);
}

function applyManual(save=false){
  try{
    const openerSel=$('#mfOpener').value;
    const opener = openerSel.includes('Auto')? openerOf($('#raw').value): openerSel;
    const labelSel=$('#mfLabel').value;
    const label = labelSel.includes('Auto')? moneyLabel(opener): labelSel;
    const amt=$('#mfAmount').value.trim();
    const moneyObj=/negotiable/i.test(amt)||!amt? null: parseMoney(amt) || {text:'$'+formatDots(+amt||0)};
    const subject= $('#mfSubject').value.trim() || extractSubject($('#raw').value, detectCategory($('#raw').value));
    const cat=detectCategory($('#raw').value);
    $('#out').value = compose(opener, subject, cat, label, moneyObj);
    if(save){
      const rules=loadRules(); rules.push({find:'(level\\s*[1-4]|lvl\\s*[1-4])', replace: subject}); saveRules(rules); showRules();
    }
  }catch(err){ console.error(err); }
}

function generate(){
  try{
    $('#flags').innerHTML=''; $('#out').value='';
    let raw=trim($('#raw').value||''); if(!raw) return;
    if($('#autoRules').checked){ for(const r of loadRules()){ try{ raw=raw.replace(new RegExp(r.find,'ig'), r.replace); }catch{} } }
    for(const bad of CAT.blacklist){ if(new RegExp(bad,'i').test(raw)){ $('#out').value=`Rejected: contains blacklisted content.`; badge('Rejected'); return; } }
    const norm=normalize(raw);
    const opener=openerOf(norm);
    const cat=detectCategory(norm);
    const subject=extractSubject(norm, cat);
    const mChunk = norm.match(/\b(?:price|budget|rent)\s*[:\-]?\s*([^\s][^\n\r]*)/i);
    let moneyObj=parseMoney(mChunk?mChunk[1]:norm);
    const label=moneyLabel(opener);
    // fill Manual Fix
    $('#mfOpener').value=opener;
    $('#mfLabel').value=label;
    $('#mfAmount').value=moneyObj? moneyObj.text.replace('$','').replace(' Million','m'):'Negotiable';
    $('#mfSubject').value=subject;
    $('#out').value = compose(opener, subject, cat, label, moneyObj);
    badge(`Detected: ${cat}`); badge(`Action: ${opener}`); badge(`Money: ${label}`); if(moneyObj) badge('k/m fixed');
  }catch(err){ console.error(err); }
}

document.addEventListener('DOMContentLoaded', ()=>{
  $('#gen').onclick=generate;
  $('#clear').onclick=()=>{$('#raw').value=''; $('#out').value=''; $('#flags').innerHTML='';}
  $('#copy').onclick=()=>{ const o=$('#out'); o.select(); document.execCommand('copy'); }
  $('#apply').onclick=()=>applyManual(false);
  $('#applySave').onclick=()=>applyManual(true);
  loadCatalog().then(()=>{ $('#raw').value='selling level 3 pickaxe price 20k'; });
});
</script>
</body>
</html>
