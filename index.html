<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lifeinvader Ad Formatter</title>
<style>
  :root{
    --bg:#0b0c0f; --fg:#e7e8ea; --muted:#a8acb3; --card:#14161a; --accent:#6aa6ff; --ok:#3ecf8e; --warn:#ffb648; --bad:#ff5a7a; --chip:#1f2329;
    --shadow:0 8px 24px rgba(0,0,0,.25);
  }
  [data-theme="light"]{
    --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --accent:#2563eb; --ok:#10b981; --warn:#d97706; --bad:#e11d48; --chip:#eef2f7;
    --shadow:0 8px 24px rgba(15,23,42,.08);
  }
  html,body{height:100%;}
  body{
    margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg); color:var(--fg);
  }
  .app{max-width:1100px; margin:0 auto; padding:16px;}
  header{
    display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap; margin-bottom:12px;
  }
  .title{font-weight:800; letter-spacing:.2px; font-size:1.1rem}
  .mode{
    display:flex; align-items:center; gap:8px;
  }
  .toggle{appearance:none; width:52px; height:28px; border-radius:999px; position:relative; background:var(--chip); outline:2px solid transparent; cursor:pointer; box-shadow:var(--shadow)}
  .toggle:before{content:""; position:absolute; width:22px; height:22px; border-radius:50%; top:3px; left:3px; background:var(--fg); transition:transform .2s ease}
  .toggle:checked{background:linear-gradient(90deg,var(--accent),#22d3ee)}
  .toggle:checked:before{transform:translateX(24px)}
  .grid{
    display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;
  }
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card); border-radius:16px; padding:14px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,.06)}
  label{display:block; font-weight:600; margin-bottom:6px}
  textarea, input, select{
    width:100%; border-radius:12px; border:1px solid rgba(127,127,127,.25); background:transparent; color:var(--fg);
    padding:12px; outline:none; box-shadow: inset 0 0 0 9999px rgba(255,255,255,0);
  }
  textarea{min-height:130px; resize:vertical}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    appearance:none; border:0; padding:12px 14px; border-radius:12px; color:#fff; background:var(--accent);
    font-weight:700; cursor:pointer; box-shadow:var(--shadow);
  }
  .btn.secondary{background:#7c8596}
  .btn.ghost{background:transparent; color:var(--fg); border:1px dashed rgba(127,127,127,.35)}
  .muted{color:var(--muted); font-size:.92rem}
  .output{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background:var(--chip); border-radius:12px; padding:12px; white-space:pre-wrap; word-break:break-word;
  }
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{background:var(--chip); padding:6px 10px; border-radius:999px; font-size:.82rem}
  .chip.ok{background: rgba(16,185,129,.12); color:var(--ok)}
  .chip.bad{background: rgba(225,29,72,.12); color:var(--bad)}
  .list{display:grid; gap:10px}
  .ad{
    border:1px solid rgba(127,127,127,.25); border-radius:14px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);
  }
  .ad .hdr{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:6px}
  .ad .cat{font-weight:700; padding:4px 8px; border-radius:8px; background:var(--chip)}
  .ad .text{white-space:pre-wrap}
  .search-bar{display:flex; gap:8px}
  .pill{padding:8px 12px; border-radius:999px; background:var(--chip)}
  .warning{border-left:4px solid var(--warn); padding:8px 10px; background:rgba(217,119,6,.12); border-radius:10px; margin-top:8px}
  .error{border-left:4px solid var(--bad); padding:8px 10px; background:rgba(225,29,72,.12); border-radius:10px; margin-top:8px}
  .success{border-left:4px solid var(--ok); padding:8px 10px; background:rgba(16,185,129,.12); border-radius:10px; margin-top:8px}
  .small{font-size:.86rem}
</style>
</head>
<body data-theme="dark">
  <div class="app">
    <header>
      <div class="title">Lifeinvader Ad Formatter • EN-03</div>
      <div class="mode">
        <span class="pill small">Day / Night</span>
        <input id="themeToggle" class="toggle" type="checkbox" aria-label="Toggle theme" />
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Composer -->
      <section class="card">
        <label for="raw">Raw ad text</label>
        <textarea id="raw" placeholder='e.g., selling house no 85 // buyyingng a Ruby. Price: Negotiable.'></textarea>

        <div class="row" style="margin-top:10px">
          <button id="formatBtn" class="btn">Generate formatted ad</button>
          <button id="addBtn" class="btn secondary" title="Adds the last formatted ad to the list">Add to list</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>

        <div id="policyHints" class="small muted" style="margin-top:10px">
          • Starts with Buying / Selling / Trading / Selling or trading. • Buyer → <b>Budget</b>, Seller → <b>Price</b>. • Use <b>№</b> for numbered homes. • Default to <b>Negotiable</b>.
        </div>

        <div id="alerts"></div>

        <div style="margin-top:12px">
          <label>Formatted output</label>
          <div id="out" class="output" role="status" aria-live="polite"></div>
        </div>
      </section>

      <!-- RIGHT: Live metadata -->
      <aside class="card">
        <label>Detected category</label>
        <div id="category" class="chips" style="margin-bottom:8px">
          <span class="chip">—</span>
        </div>

        <label>Checks</label>
        <div id="checks" class="chips">
          <span class="chip">Capitalization</span>
          <span class="chip">Price/Budget</span>
          <span class="chip">№ format</span>
          <span class="chip">Punctuation</span>
        </div>

        <div style="margin-top:12px">
          <label>Search ads</label>
          <div class="search-bar">
            <input id="search" placeholder="Search formatted list…" />
            <button id="searchBtn" class="btn">Search</button>
          </div>
        </div>

        <div class="warning small" style="margin-top:12px">
          <b>Note:</b> Ads containing blacklisted terms (e.g., firearms, drugs, covid masks) are rejected automatically per policy.
        </div>
      </aside>
    </div>

    <!-- Ads list -->
    <section class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <label>Generated ads</label>
        <button id="exportBtn" class="btn ghost small">Export JSON</button>
      </div>
      <div id="list" class="list"></div>
    </section>
  </div>

<script>
(function(){
  const el = id => document.getElementById(id);
  const raw = el('raw'), out = el('out'), cat = el('category'), checks = el('checks');
  const alerts = el('alerts'), list = el('list');
  const themeToggle = el('themeToggle');
  const search = el('search');

  // Persist theme
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.setAttribute('data-theme', savedTheme);
  themeToggle.checked = savedTheme === 'light';
  themeToggle.addEventListener('change', () => {
    document.body.setAttribute('data-theme', themeToggle.checked ? 'light' : 'dark');
    localStorage.setItem('theme', themeToggle.checked ? 'light' : 'dark');
  });

  // Blacklist terms (subset from policy, extend as needed)
  const BLACKLIST = [
    'firearm','gun','pistol','rifle','ammo','ammunition','bulletproof','armor plate',
    'weed','cannabis','cocaine','drug','balaclava','rope','lockpick','crowbar',
    'covid mask','surgical mask','ems mask','vehicle scanner','human scanner','radar',
    'anti-radar','usb with virus','bandit mask','animal skin'
  ];

  // Category keyword maps (policy-driven)
  const CATS = {
    "Real Estate": ['house','apartment','penthouse','mansion','garage','g.s.','w.h.','helipad','garden','mirror park','vinewood','hills','view'],
    "Auto": ['car','truck','motorcycle','bike','atv','boat','helicopter','plane','vehicle','insurance','drift kit','turbo kit','luminous wheels','configuration'],
    "Businesses": [
      'ammunition store','bar','car wash','chip tuning','clothing shop','cowshed','electric station','farm','flower shop','freight train','gas station','hair salon',
      'jewelry store','oil well','parking','plantation','car sharing','state object','service station','24/7 store','tattoo studio','taxi company','atm','juice shop','burger shop','warehouse'
    ],
    "Work": ['hiring','looking for work','looking for a job','salary','award','bonus','construction site','driver','lawyer','dj','photographer','bodyguard','assistant','professional dancer','professional singer','trucker','experience'],
    "Dating": ['looking for','looking for a boyfriend','girlfriend','wife','husband','valentine','family','friends','date','poker players'],
    "Discounts": ['%','percent discount','discount'],
    "Services": ['happy hour','template','service','we are offering','join','call us'],
    "Other": ['party','car meet','dice','fish','fishing rod','fruits','vegetables','mask','video card','repair kit','token','thread','snow','ticket','license plate','luminous wheels','pickaxe','tuning','elixir','pet','container','battery','fuel','wires','prime','prime platinum','sim card','lottery','resource','miner','inventory','backpack skin','tonic','pearl','statue','drawing','mushroom','paint can','timber','scrap metal','top quality metal']
  };

  // Helpers
  const titleCaseFirst = s => s ? s[0].toUpperCase() + s.slice(1) : s;
  const dotsThousands = (n) => {
    // turns 1500 -> 1.500, 1000000 -> 1.000.000
    const [intPart, decPart] = String(Math.trunc(Math.abs(n))).split('.');
    const withDots = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return withDots + (decPart ? '.' + decPart : '');
  };
  const toPolicyMoney = str => {
    // Convert k/M shorthand and raw numbers to policy format
    // $ must be prefixed; decimals use dot; thousand sep is dot
    // Examples: "1k" -> $1.000, "1.7k each" -> $1.700 each, "3m" -> $3 Million
    return str.replace(/\$?\s*([\d.,]+)\s*([kKmM])\b/g, (_, num, suffix) => {
      const val = parseFloat(String(num).replace(/,/g,'.'));
      if (!isFinite(val)) return `$${num}`;
      if (suffix.toLowerCase() === 'k') {
        return `$${dotsThousands(Math.round(val*1000))}`;
      } else {
        // M -> Million
        return `$${val % 1 === 0 ? val.toFixed(0) : String(val)} Million`;
      }
    }).replace(/\$?\s*([\d][\d,\.]*)\b(?!\s*Million)/g, (_, num) => {
      // plain numbers -> $X with dot thousands; keep decimals if any
      const clean = String(num).replace(/,/g,'');
      if (!/^\d+(\.\d+)?$/.test(clean)) return `$${num}`;
      const n = Number(clean);
      // If it's large (>= 1000000) and looks like "1000000", prefer dot grouping (1.000.000)
      return `$${dotsThousands(n)}`;
    });
  };

  const fixTypos = s => {
    const map = [
      [/buyyingng|buyying|buyyy?ing|buyin\b|looking to (?:buy|purchase)|look(?:ing)? to (?:buy|purchase)/gi, 'Buying'],
      [/selling or trading|sell(?:ing)? ?\/ ?trading|s\/t/gi, 'Selling or trading'],
      [/sell(?:ing)?/gi, 'Selling'],
      [/trad(?:e|ing)/gi, 'Trading'],
      [/rent(?:ing)? out/gi, 'Renting out'],
      [/rent(?:ing)?/gi, 'Renting'],
      [/budget:?/gi, 'Budget:'],
      [/price:?/gi, 'Price:'],
      // normalize "no|number" before digits to №
      /\b(house|apartment|penthouse|mansion)\s*(no\.?|number)\s*(\d+)\b/gi,
      (m,what,_n, num)=> `${what} №${num}`
    ];
    let out = s;
    for (let i=0;i<map.length;i++){
      const pat = map[i];
      if (pat instanceof Array) continue;
    }
    // apply pairwise rules
    for (let i=0;i<map.length;i+=2){
      const a = map[i], b = map[i+1];
      out = out.replace(a, b);
    }
    // Special: "Casino apartment" -> "Casino penthouse"
    out = out.replace(/\bcasino apartment\b/gi, 'Casino penthouse');
    return out;
  };

  const indefiniteArticle = word => /^[aeiou]/i.test(word) ? 'an' : 'a';

  const normalizeObject = (text, action) => {
    // extract the object phrase after action word, before a dot or "price/budget/rent"
    const lower = text.toLowerCase();
    const idx = lower.search(/\b(buying|selling or trading|selling|trading|renting out|renting)\b/i);
    if (idx < 0) return {object:null, rest:text};
    const m = /(?:buying|selling or trading|selling|trading|renting out|renting)\s+([^\.]+?)(?=(?:\s*\.\s*|$|price:|budget:|rent:))/i.exec(text);
    let obj = m ? m[1].trim() : null;

    if (!obj) return {object:null, rest:text};

    // house numbering: "house 85" -> "house №85"
    obj = obj.replace(/\b(house|apartment|penthouse|mansion)\s*(?:#|no\.?|number)?\s*(\d+)\b/gi, (m, typ, num)=> `${typ} №${num}`);

    // ensure "a/an" for singular generic nouns when no № and no quotes
    if (/^(house|apartment|penthouse|mansion)\b(?!\s*№)/i.test(obj)) {
      obj = obj.replace(/^(house|apartment|penthouse|mansion)\b/i, (m)=> `${indefiniteArticle(m)} ${m}`);
    }
    if (/^car\b/i.test(obj)) obj = obj.replace(/^car\b/i, `${indefiniteArticle('car')} car`);

    // mining resources lowercased singulars
    obj = obj
      .replace(/\b(Ruby|Emerald|Diamond)\b/g, (w)=> w.toLowerCase())
      .replace(/\bA ruby\b/i,'a ruby');

    return {object:obj, rest:text};
  };

  const detectAction = str => {
    const s = str.toLowerCase();
    if (/\bselling or trading\b/.test(s)) return 'Selling or trading';
    if (/\bselling\b/.test(s)) return 'Selling';
    if (/\btrading\b/.test(s)) return 'Trading';
    if (/\brenting out\b/.test(s)) return 'Renting out';
    if (/\brenting\b/.test(s)) return 'Renting';
    if (/\bbuying\b/.test(s) || /\blooking to buy\b/.test(s)) return 'Buying';
    if (/\blooking for\b/.test(s)) return 'Looking for';
    return null;
  };

  const finalizePunctuation = s => {
    s = s.replace(/\s+/g,' ').trim();
    // ensure sentence 1 ends with period ONLY if it doesn't already end with number + and more text follows
    s = s.replace(/(№\d+)(?=\s|$)/g, '$1'); // keep №N
    // add final period unless ends with a digit or period already there after a money value like $1.500
    if (!/[\.]$/.test(s) && !/\d$/.test(s)) s += '.';
    return s;
  };

  const pickCategory = (formatted) => {
    const s = formatted.toLowerCase();
    for (const [k, arr] of Object.entries(CATS)) {
      if (arr.some(w => s.includes(w))) {
        return k;
      }
    }
    // Special: if starts with Buying/Selling etc but no keyword matched
    return 'Other';
  };

  const moneyBlock = (action, hasAnyPriceBudget, provided) => {
    if (/Renting/.test(action)) {
      return provided || 'Rent: Negotiable.';
    }
    if (action === 'Trading') {
      // often no price; keep provided if any
      return provided || '';
    }
    if (action === 'Selling or trading' || action === 'Selling') {
      return provided || 'Price: Negotiable.';
    }
    if (action === 'Buying' || action === 'Looking for') {
      return provided || 'Budget: Negotiable.';
    }
    return provided || '';
  };

  const extractAndNormalizeMoneyLine = (txt) => {
    // Detect existing Price/Budget/Rent lines and normalize formats
    const moneyLineMatch = /(Price|Budget|Rent)\s*:?\s*([^.]*)/i.exec(txt);
    let line = null;
    if (moneyLineMatch){
      let label = titleCaseFirst(moneyLineMatch[1].toLowerCase()); // Price/Budget/Rent
      let rest = moneyLineMatch[2].trim();
      if (!rest) rest = 'Negotiable';
      // Normalize k/M and numbers
      rest = toPolicyMoney(rest);
      // Ensure 'Negotiable' capitalized
      rest = rest.replace(/\bnegotiable\b/gi, 'Negotiable');
      // Prevent trailing period if ends with a number
      const sentence = `${label}: ${rest}${/\d$/.test(rest) ? '' : '.'}`;
      line = sentence;
    }
    return line;
  };

  const checkBlacklist = (txt) => {
    const s = txt.toLowerCase();
    const hits = BLACKLIST.filter(t => s.includes(t));
    return hits;
  };

  function formatAd(input){
    alerts.innerHTML = '';
    const original = input.trim();
    if (!original) return {formatted:'', category:'—', problems:[]};

    // Step 1: normalize typos/phrases
    let s = fixTypos(original);

    // Step 2: detect action
    let action = detectAction(s);
    if (!action){
      // default: try to infer from "price/budget/rent" or nouns
      if (/budget\s*:|looking to buy|looking for/i.test(s)) action = 'Buying';
      else if (/price\s*:|sell/i.test(s)) action = 'Selling';
      else action = 'Selling'; // safe default
    }

    // Step 3: object phrase
    const {object} = normalizeObject(s, action);

    // Step 4: first sentence
    let first = action;
    if (object) {
      // Ensure quotes around auto model patterns like "Brand Model"
      // We keep as-is for general items. Capitalize the first letter only.
      first += ' ' + object.trim();
    } else {
      // generic fallbacks
      if (/house|apartment|penthouse|mansion/i.test(s)) first += ' a house';
      else if (/car|vehicle/i.test(s)) first += ' a car';
    }
    first = first.replace(/\s+\.$/, ''); // avoid stray dot
    first = titleCaseFirst(first);

    // Ensure period at end of sentence 1 if it does not end with a number AND we will have a second sentence
    let moneyProvided = extractAndNormalizeMoneyLine(s);
    let firstSentence = finalizePunctuation(first);
    // If first ends with number and we added a period, keep it (policy examples keep it even if more sentences follow)

    // Step 5: price/budget/rent sentence
    const secondSentence = moneyBlock(action, !!moneyProvided, moneyProvided);

    // Step 6: glue
    const formatted = [firstSentence, secondSentence].filter(Boolean).join(' ');

    // Step 7: category
    const category = pickCategory(formatted);

    // Step 8: checks and blacklist
    const problems = [];
    const hits = checkBlacklist(original);
    if (hits.length){
      problems.push({type:'error', msg:`Rejected: contains blacklisted terms: ${hits.join(', ')}`});
    }

    // Validation chips (simple signals)
    renderChecks({ formatted, action });

    return {formatted, category, problems};
  }

  function renderChecks({formatted, action}){
    checks.innerHTML = '';
    const add = (text, cls='')=>{
      const span = document.createElement('span');
      span.className = 'chip ' + cls;
      span.textContent = text;
      checks.appendChild(span);
    };
    // Capitalization
    /^[A-Z]/.test(formatted) ? add('Capitalization ✓','ok') : add('Capitalization ✕','bad');
    // Price/Budget rule
    if (/Budget:/.test(formatted) && /^(Buying|Looking for)/.test(formatted)) add('Buyer→Budget ✓','ok');
    else if (/Price:|Rent:/.test(formatted) && /^(Selling|Trading|Selling or trading|Renting)/.test(formatted)) add('Seller/Rent ✓','ok');
    else add('Money label ✕','bad');

    // № format
    /house №\d+|apartment №\d+|penthouse №\d+|mansion №\d+/i.test(formatted) ? add('№ format ✓','ok') : add('№ format —');

    // Punctuation end
    /(\.|\d)$/.test(formatted.trim()) ? add('Punctuation ✓','ok') : add('Punctuation ✕','bad');
  }

  // UI handlers
  el('formatBtn').addEventListener('click', () => {
    const {formatted, category, problems} = formatAd(raw.value);
    out.textContent = formatted;
    cat.innerHTML = `<span class="chip">${category}</span>`;
    renderProblems(problems);
  });

  el('addBtn').addEventListener('click', () => {
    const text = out.textContent.trim();
    if (!text) return;
    const category = pickCategory(text);
    const item = { id: Date.now(), text, category };
    ADS.push(item);
    renderList(ADS);
    raw.value = '';
    out.textContent = '';
    cat.innerHTML = `<span class="chip">—</span>`;
    alerts.innerHTML = `<div class="success">Added to list.</div>`;
    setTimeout(()=>alerts.innerHTML='', 2000);
  });

  el('clearBtn').addEventListener('click', () => {
    raw.value = ''; out.textContent=''; cat.innerHTML = `<span class="chip">—</span>`; alerts.innerHTML='';
  });

  el('searchBtn').addEventListener('click', ()=> renderList(ADS, search.value));
  search.addEventListener('keydown', e=>{ if(e.key==='Enter') el('searchBtn').click(); });

  el('exportBtn').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(ADS,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'ads.json'; a.click();
    URL.revokeObjectURL(url);
  });

  function renderProblems(problems){
    alerts.innerHTML = '';
    problems.forEach(p => {
      const div = document.createElement('div');
      div.className = p.type==='error' ? 'error' : 'warning';
      div.innerHTML = p.msg;
      alerts.appendChild(div);
    });
  }

  const ADS = [];

  function renderList(items, q=''){
    const norm = (s)=> s.toLowerCase();
    let filtered = items;
    if (q && q.trim()){
      const needle = norm(q.trim());
      filtered = items.filter(i => norm(i.text).includes(needle) || norm(i.category).includes(needle));
    }
    list.innerHTML = '';
    filtered.forEach(i => {
      const div = document.createElement('div');
      div.className = 'ad';
      div.innerHTML = `
        <div class="hdr">
          <div class="cat">${i.category}</div>
          <div class="muted small">${new Date(i.id).toLocaleString()}</div>
        </div>
        <div class="text">${escapeHtml(i.text)}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn ghost small" data-copy="${i.id}">Copy</button>
          <button class="btn ghost small" data-del="${i.id}">Delete</button>
        </div>
      `;
      list.appendChild(div);
    });
    // buttons
    list.querySelectorAll('button[data-copy]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.getAttribute('data-copy');
        const item = items.find(x=> String(x.id)===id);
        navigator.clipboard.writeText(item.text);
        b.textContent = 'Copied ✓';
        setTimeout(()=>b.textContent='Copy', 1000);
      });
    });
    list.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = Number(b.getAttribute('data-del'));
        const idx = ADS.findIndex(x => x.id===id);
        if (idx>=0){ ADS.splice(idx,1); renderList(ADS); }
      });
    });
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c]));
  }

  // Quick demos for your examples:
  raw.value = 'selling house no 85';
  el('formatBtn').click(); // Produces: Selling house №85. Price: Negotiable.
})();
</script>
</body>
</html>
