<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lifeinvader Ads — EN-03 • Auto-Detect + Manual Fix</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f1720;--panel:#121a24;--ink:#e6eef7;--muted:#9fb1c5;--chip:#1c2733;
  --brand:#4da3ff;--ok:#2ecc71;--warn:#ffb020;--bad:#ff5a5a;--btn:#1b6fe7;
  --btn-ink:#fff;--line:#203040;--accent:#2a3848;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);line-height:1.45}
.wrap{max-width:980px;margin:40px auto;padding:0 16px}
h1{font-size:20px;margin:0 0 14px;display:flex;gap:8px;align-items:center}
h1 .bolt{color:#ffd166}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
textarea,input,select{width:100%;background:#0c1219;color:var(--ink);border:1px solid var(--accent);border-radius:10px;padding:12px;font:inherit;outline:none}
textarea{min-height:150px;resize:vertical}
.btn{background:var(--btn);color:var(--btn-ink);border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
.btn.secondary{background:#1f2a36}
.btn.ghost{background:transparent;border:1px solid var(--accent)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.out{background:#0c1219;border:1px dashed var(--accent);padding:12px;border-radius:10px;min-height:44px}
.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.chip{background:var(--chip);color:var(--muted);padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--accent)}
.chip.ok{color:#bff3cf;border-color:#294e3a;background:#15251c}
.chip.bad{color:#ffd3d3;border-color:#4a2626;background:#241212}
.chip.warn{color:#fff0c2;border-color:#4a4126;background:#241f12}
.muted{color:var(--muted)}
.two{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:840px){.two{grid-template-columns:1fr 1fr}}
.kicker{font-size:12px;color:var(--muted);margin:6px 0 0}
.bar{display:flex;gap:8px;align-items:center;margin-top:10px}
.right{margin-left:auto}
.tiny{font-size:11px}
.foot{margin-top:24px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1><span class="bolt">⚡</span> Auto-Detect (Raw Ad) + Manual Fix</h1>
  <p class="muted tiny">Loads a big rules catalog from <code>catalog.json</code>. If it’s missing, a rich fallback is bundled, so it still works.</p>

  <div class="card">
    <label class="muted tiny">RAW AD TEXT</label>
    <textarea id="raw" placeholder="e.g., hiring solar panel workers • buying level 2 engine 2pcs • selling house №758 with garden"></textarea>
    <div class="bar">
      <button id="gen" class="btn">Generate</button>
      <button id="clear" class="btn secondary">Clear</button>
      <span class="right tiny muted" id="status">Ready.</span>
    </div>

    <div style="height:10px"></div>

    <div class="out" id="out">Your formatted ad will appear here…</div>
    <div class="bar">
      <button id="copy" class="btn ghost">Copy</button>
      <div id="badges" class="chips"></div>
    </div>
  </div>

  <div style="height:18px"></div>

  <div class="card">
    <h3 style="margin:0 0 10px">Manual Fix (optional)</h3>
    <p class="muted tiny">Auto-filled from detection. Edit and Apply. “Apply &amp; Save” stores a local rule so similar raw ads get fixed <em>before</em> parsing.</p>

    <div class="two">
      <div>
        <label class="muted tiny">Opener</label>
        <select id="mfOpener">
          <option value="auto">Auto (detected)</option>
          <option>Buying</option>
          <option>Selling</option>
          <option>Trading</option>
          <option>Selling or trading</option>
          <option>Renting out</option>
          <option>Hiring</option>
          <option>Looking to work</option>
          <option>Looking for</option>
        </select>
      </div>
      <div>
        <label class="muted tiny">Money label</label>
        <select id="mfMoneyLabel">
          <option value="auto">Auto (detected)</option>
          <option>Price</option>
          <option>Budget</option>
          <option>Rent</option>
          <option>Salary</option>
          <option>Bet</option>
          <option>None</option>
        </select>
      </div>
      <div>
        <label class="muted tiny">Subject (edit main sentence)</label>
        <input id="mfSubject" placeholder='e.g., house №85 with a garden, 5 g.s. and insurance'>
      </div>
      <div>
        <label class="muted tiny">Amount</label>
        <input id="mfAmount" placeholder='e.g., 20k, 1.7k each, 1.5m, Negotiable, $250k per week'>
        <div class="kicker tiny muted">k/m shorthands: 20k → $20.000, 1.5k → $1.500, 50m → $50 Million. Add “each” or “per week/day/month”.</div>
      </div>
    </div>

    <div class="bar" style="margin-top:14px">
      <button id="apply" class="btn secondary">Apply</button>
      <button id="applySave" class="btn">Apply &amp; Save</button>
      <label class="right tiny"><input id="autoRules" type="checkbox" checked> Auto-apply rules</label>
    </div>

    <div class="kicker tiny muted" id="rulesInfo">No rules saved yet.</div>
  </div>

  <div class="foot">
    EN-03 policy: openers; Price/Budget/Rent/Salary; dot-thousands + “Million”; level→quality (1–4 → low/medium/high/max);
    Real-Estate feature order; Business canonical names; Work rules; containers; blacklist & non-sellable checks; Discounts/Services templates; RP ticket→Grand ticket; crypto→tokens; pets; bulk “each”.
  </div>
</div>

<script>
const $ = s=>document.querySelector(s);
const rawEl=$("#raw"), outEl=$("#out"), statusEl=$("#status"), badgesEl=$("#badges");
const mfOpener=$("#mfOpener"), mfSubject=$("#mfSubject"), mfMoney=$("#mfMoneyLabel"), mfAmount=$("#mfAmount");
const btnGen=$("#gen"), btnClear=$("#clear"), btnCopy=$("#copy"), btnApply=$("#apply"), btnApplySave=$("#applySave"), chkAuto=$("#autoRules");

let CATALOG=null;

const FALLBACK={
  // ---------- blacklist (global) ----------
  blacklist:[
    "firearm","gun","pistol","rifle","shotgun","ammo","ammunition","bulletproof","armor plate",
    "weed","cannabis","marijuana","cocaine","drug","balaclava","covid mask","ems mask","surgical mask",
    "radar","scanner","anti-radar","head bag","rope","crowbar","usb with virus","troll ad",
    "animal skin","barricade","satellite dish","engine block","air horn","grand coin","battlepass",
    "nationality","sexual","sell people","branded armor","hype body","gang","black market"
  ],
  // places we never promote parties
  banned_party_places:["lspd","fib","sahp","ems","government","ghetto","mega mall","black market","gang hq","gang"],
  // special bypass: discount/service templates can reference weapon shop without rejection (per your examples)
  whitelist_context:["weapon shop","ammunition store","charging station"],

  nonsellable_autos:[
    /(?:^|\s)p1\s*car\b/i,
    /\bbenefactor[-\s]?maybach\s+gls\s*600\b/i
  ],

  business_map:{
    "barber":"Hair salon business","barber shop":"Hair salon business","hair salon":"Hair salon business",
    "gun store":"Ammunition Store business","weapon shop":"Ammunition Store business","weapon store":"Ammunition Store business",
    "drug lab":"Burger shop business","charging station":"Electric station business",
    "auto workshop":"Service station business","service station":"Service station business",
    "24/7":"24/7 Store business","24/7 store":"24/7 Store business","atm":"ATM business","atm business":"ATM business",
    "car wash":"Car wash business","chip tuning":"Chip tuning business","clothing shop":"Clothing shop business",
    "cowshed":"Cowshed business","plantation":"Plantation business","taxi company":"Taxi company business",
    "grand elite":"Grand Elite business","jewelry store":"Jewelry store business","oil well":"Oil Well business",
    "parking":"Parking business","pet shop":"Pet Shop business","car sharing":"Car sharing business",
    "state object":"State object business","tattoo studio":"Tattoo studio business","gas station":"Gas station business",
    "burger shop":"Burger shop business","warehouse":"Warehouse business","freight train":"Freight train business",
    "flower shop":"Flower shop business","electric station":"Electric station business","farm":"Farm business",
    "juice shop":"Juice shop business","fight club":"Fight club business"
  },

  container_map:[
    {pattern:/\bp1\s*car\s*(cases?|containers?)\b/i,out:"Progen containers"},
    {pattern:/\bcar\s*cases?\b/i,out:"car containers"}
  ],

  official_places:["Vinewood Hills","Rockford Hills","Richman","Sandy Shores","Paleto Bay","Postal","Hospital","Capitol","Fire Station","Auto Fair","Bahama Mamas Bar","Tequi-la-la Bar","FIB","Hotel Spa Bar","Pacific Bluffs Country Club","Diamond Resort Bar","Vanilla Unicorn Bar","Church","Stock Exchange","Stadium","Chumash","Lifeinvader","Del Perro Pier","Del Perro Beach","Cayo Perico Island","Hotel","Raton Canyon","School","SAHP"],
  unofficial_places:["airport","autosalon","beach","beach market","post office","train station","yacht","ghetto"],

  vehicle_synonyms:{
    "supra":"Karin Supra A80",
    "pista f488":"Grotti Pista (F488)"
  },

  clothing_brand_map:{
    "adidas":"Abibas"
  }
};

async function loadCatalog(){
  try{
    const r=await fetch("catalog.json",{cache:"no-store"});
    if(!r.ok) throw 0;
    const j=await r.json();
    CATALOG={...FALLBACK,...j};
    status("Catalog loaded.");
  }catch(e){ CATALOG=FALLBACK; status("Catalog fallback."); }
}

function status(m){statusEl.textContent=m}
function clearBadges(){badgesEl.innerHTML=""}
function badge(t,c=""){const s=document.createElement("span");s.className="chip "+c;s.textContent=t;badgesEl.appendChild(s)}
function copyText(s){navigator.clipboard.writeText(s||"").then(()=>status("Copied."))}
function dotThousands(n){return n.replace(/\B(?=(\d{3})+(?!\d))/g,".")}

function asMoney(raw){
  if(!raw) return "";
  raw=raw.trim();
  if(/^negotiable$/i.test(raw)) return "Negotiable";
  const each = /\beach\b/i.test(raw) ? " each":"";
  const per  = /\bper\s*(week|day|month)\b/i.exec(raw);
  const perTxt = per?` per ${per[1]}`:"";
  let s = raw.replace(/\$/g,"").replace(/,/g,"").trim();

  let m;
  if( (m=s.match(/^(\d+(?:\.\d+)?)\s*m/i)) ){
    const v=parseFloat(m[1]); return `$${v} Million${each}${perTxt}`;
  }
  if( (m=s.match(/^(\d+(?:\.\d+)?)\s*k/i)) ){
    const v=Math.round(parseFloat(m[1])*1000)+""; return `$${dotThousands(v)}${each}${perTxt}`;
  }
  if( /^\d+$/.test(s) ) return `$${dotThousands(s)}${each}${perTxt}`;
  return raw;
}

const RULE_KEY="li_rules_v1";
const getRules=()=>{try{return JSON.parse(localStorage.getItem(RULE_KEY)||"[]")}catch{return[]}}
const setRules=a=>{localStorage.setItem(RULE_KEY,JSON.stringify(a));showRulesInfo()}
function showRulesInfo(){const n=getRules().length; $("#rulesInfo").textContent = n?`${n} rule${n>1?"s":""} saved. Auto-apply is ${$("#autoRules").checked?"on":"off"}.`:"No rules saved yet."}
function applyLocalRules(s){for(const r of getRules()){try{const re=new RegExp(r.pattern,"i"); if(re.test(s)) s=s.replace(re,r.replacement)}catch{}} return s}

function fixTypos(s){
  let t=` ${s.toLowerCase()} `;
  t=t.replace(/\booking\s+work\b/g,"looking to work");
  t=t.replace(/\bprofss?ionil\b/g,"professional").replace(/\bdncer\b/g,"dancer");
  t=t.replace(/\bsellin\b/g,"selling").replace(/\bpice\b/g,"price").replace(/\bmlon\b/g,"million");
  t=t.replace(/\bi want to but\b/g,"i want to buy");
  t=t.replace(/\brp\s*ticket\b/g,"grand ticket");
  t=t.replace(/\bcrypto\s*currency\b/g,"tokens");
  t=t.replace(/\bseed bulk\b/g,"seeds in bulk").replace(/\bseed\b/g,"seeds");
  t=t.replace(/\bparty at\s+fib\b/g,"party at fib");
  return t.trim();
}
function applyContainerMaps(s){for(const m of CATALOG.container_map){s=s.replace(m.pattern,m.out)} return s}
function levelToQuality(s){
  return s
   .replace(/\bmax\s+level\b/ig,"max quality")
   .replace(/\b(?:level|lvl)\s*1\b/ig,"low quality")
   .replace(/\b(?:level|lvl)\s*2\b/ig,"medium quality")
   .replace(/\b(?:level|lvl)\s*3\b/ig,"high quality")
   .replace(/\b(?:level|lvl)\s*4\b/ig,"max quality");
}
function sentenceCase(s){s=s.trim();return s? s[0].toUpperCase()+s.slice(1):s}

function parseQuantizedTunings(s){
  // e.g., "2pcs level 2 engine. 3pcs lvl 2 tire and 2pcs lvl 3 transmission"
  const parts=[];
  const re = /(\d+)\s*(?:pcs|x)?\s*(?:of\s*)?(?:level|lvl)?\s*(\d)\s*(engine|transmission|suspension|tires?)/ig;
  let m;
  while(m=re.exec(s)){
    const qty=m[1]|0, lvl=m[2]|0, kind=m[3].toLowerCase();
    const q = lvl==1?"low":(lvl==2?"medium":(lvl==3?"high":"max"));
    const noun = /tires?/.test(kind) ? "tires" : kind;
    parts.push(`${qty} ${q} quality ${noun} tunings`);
  }
  return parts;
}

function detectDiscountTemplate(s){
  return /\b(?:% ?off|discount)\b/i.test(s) || /\boff\b/i.test(s) && /\b\d{1,3}%\b/.test(s);
}
function detectServicesTemplate(s){
  return /\bgps\s*№\d+\b/i.test(s) || /\bjoin\b/i.test(s) || /\bcontact\b/i.test(s) || /\bcharging\b/i.test(s) || /\bprovides\b/i.test(s) || /\boffice\b/i.test(s);
}

function detectBlacklistOrNonSellable(s, context){
  const low=s.toLowerCase();
  const isDiscount=detectDiscountTemplate(s);
  const isService=detectServicesTemplate(s);
  if((isDiscount||isService) && CATALOG.whitelist_context.some(w=>low.includes(w))) return {reject:false};

  for(const w of CATALOG.blacklist){ if(low.includes(w)) return {reject:true, reason:`Contains illegal/blacklisted term: “${w}”`}; }
  for(const re of CATALOG.nonsellable_autos){ if(re.test(s)) return {reject:true, reason:`Non-sellable vehicle mentioned.`}; }
  if(/\bparty at\b/.test(low) && CATALOG.banned_party_places.some(p=>low.includes(p))) return {reject:true, reason:"We do not promote parties at that location."};
  return {reject:false};
}

function detectOpener(s){
  const low=s.toLowerCase();
  if(/\brenting out\b/.test(low)||/\brent out\b/.test(low)) return "Renting out";
  if(/\bhiring\b/.test(low)) return "Hiring";
  if(/\bi am a\b/.test(low) && /\bneed work\b/.test(low)) return "Looking to work";
  if(/\blooking to work\b/.test(low)||/\blooking for work\b/.test(low)) return "Looking to work";
  if(/\blooking for\b/.test(low)) return "Looking for";
  if(/\bi want to buy\b/.test(low)||/\bi want\b/.test(low)||/\blooking to buy\b/.test(low)||/\blooking to purchase\b/.test(low)||/\bbuying\b/.test(low)) return "Buying";
  if(/\bselling or trading\b/.test(low)) return "Selling or trading";
  if(/\btrading\b/.test(low)) return "Trading";
  if(/\bselling\b/.test(low)) return "Selling";
  return "Buying";
}

function detectCategory(s){
  const low=s.toLowerCase();
  if(/\bhouse|apartment|penthouse|mansion\b/.test(low) || /\bg\.s\.|w\.h\.|helipad|garden|custom interior\b/.test(low)) return "Real Estate";
  if(/\bbusiness\b/.test(low)|| /\bcontrol\b/.test(low)) return "Business";
  for(const k of Object.keys(CATALOG.business_map)){ if(low.includes(k)) return "Business"; }

  if(/\bcar|vehicle|motorcycle|bike|atv|boat|helicopter|plane|monowheel|license plate|seashark|supra|chiron|corvette\b/.test(low)) return "Auto";
  if(/\bhiring\b/.test(low)||/\blooking to work\b/.test(low)) return "Work";
  if(/^looking for /.test(low) || /\blooking for a (?:wife|husband|boyfriend|girlfriend|family|family members|date|valentine|friend|friends)\b/.test(low)) return "Dating";

  if(detectDiscountTemplate(s)) return "Discounts";
  if(detectServicesTemplate(s) || /\bclan|family office|join us\b/i.test(s)) return "Services";

  return "Other";
}

function moneyLabelForOpener(opener){
  switch(opener){
    case "Buying": return "Budget";
    case "Selling": return "Price";
    case "Renting out": return "Rent";
    case "Hiring": return "Salary";
    default: return "None";
  }
}

function extractMoneyRaw(s){
  if(/\bnego|negotiable\b/i.test(s)) return "Negotiable";
  const m = s.match(/\$?\s*\d+(?:\.\d+)?\s*[km]?\b(?:\s*each|\s*per\s*(?:week|day|month))?/i);
  return m?m[0].trim():"";
}

function normalizeBusinessSubject(raw){
  let low=raw.toLowerCase();
  low=low.replace(/personal business/g,"private business");
  for(const [k,canon] of Object.entries(CATALOG.business_map)){
    const re=new RegExp(`\\b${k}\\b`,"i");
    if(re.test(low)) return sentenceCase(canon.replace(/ business$/,""))+" business";
  }
  if(/\bbusiness\b/i.test(raw)) return sentenceCase(raw);
  return null;
}

function clampBusinessPrice(moneyStr){
  const m=moneyStr.match(/(\d+(?:\.\d+)?)\s*Million/i);
  if(m && parseFloat(m[1])>300) return "Negotiable";
  return moneyStr;
}

function normalizeOtherSubject(raw){
  // Adidas → Abibas; crypto→tokens already converted in typos
  let s=raw;
  s=s.replace(/\bboys?\s+adidas\b/i,"Abibas for men");
  return sentenceCase(s);
}

function normalizeWorkSubject(raw, opener){
  const r=raw.toLowerCase();
  if(opener==="Hiring" && /\bsolar\s*panel\b/.test(r)) return "Hiring workers for solar panel plantations";
  if(/\bi am a\s+(\w+)\b.*need work/.test(r)){
    const prof = r.match(/\bi am a\s+(\w+)\b/)[1];
    return sentenceCase(prof)+" looking for work";
  }
  if(/hiring family members/.test(r)) return "Looking for family members"; // policy mapping
  if(/\blooking to work\b/.test(r)) return sentenceCase(raw);
  return sentenceCase(raw);
}

function normalizeDating(raw){
  return sentenceCase(raw.replace(/\bhiring family members\b/i,"Looking for family members"));
}

function normalizeAutoSubject(raw){
  let s=raw;
  // vehicle synonyms
  for(const [k,v] of Object.entries(CATALOG.vehicle_synonyms)){
    const re=new RegExp(`\\b${k}\\b`,`i`);
    s=s.replace(re, `"${v}"`);
  }
  s=levelToQuality(s);
  s=s.replace(/\bdrift (?:tuning|assistance)\b/ig,"drift kit");
  s=s.replace(/\bturbo\b/ig,"turbo kit");
  s=s.replace(/\b(body (?:upgrades|kit)|modification|visuals?)\b/ig,"visual upgrades");
  s=s.replace(/\bluminous (?:rims|unique wheels?)\b/ig,"luminous wheels");
  return sentenceCase(s);
}

function normalizeRealEstate(raw){
  let s=raw.toLowerCase();

  // multiple houses in one ad → reject flag
  const nums=[...s.matchAll(/\b(?:no|№)?\s*(\d{1,5})\b/g)].map(m=>m[1]);
  if(/house/.test(s) && nums.length>1) return {reject:true, reason:"Cannot advertise more than 1 property number at a time."};

  // type
  const t=s.match(/\b(house|apartment|penthouse|mansion)\b/); const typ=t?t[1]:"house";

  // number
  let num=""; const n=s.match(/\b(?:house|apartment|penthouse|mansion)?\s*(?:no|№)\s*(\d{1,5})\b/); if(n) num=` №${n[1]}`;

  const feats=[];
  if(/\bgarden\b/.test(s)) feats.push("a garden");

  let gs=""; const mgs=s.match(/\b(2|5|9|25)\s*(?:g\.?s\.?|garage|garages)\b/); if(mgs) gs=mgs[1]+" g.s."; if(gs) feats.push(gs);
  let wh=""; const mwh=s.match(/\b(3|4|5)\s*(?:w\.?h\.?)\b/); if(mwh) wh=mwh[1]+" w.h."; if(wh) feats.push(wh);

  if(/\bcustom\s*interior\b/.test(s)) feats.push("custom interior");
  if(/\binsurance\b/.test(s)) feats.push("insurance");
  if(/\bhelipad\b/.test(s)) feats.push("helipad");

  const others=[];
  if(/\bswimming ?poola?\b/.test(s)||/\bswimming pool\b/.test(s)) others.push("swimming pool");
  if(/\btennis court\b/.test(s)) others.push("tennis court");
  if(/\blong|large\b/.test(s)&&/\bdriveway\b/.test(s)) others.push("long driveway");
  if(/\bspacious\b/.test(s)&&/\bbackyard\b/.test(s)) others.push("spacious backyard");
  if(/\b(?:nice|beautiful|great)\s+views?\b/.test(s)) others.push("nice views");
  if(others.length) feats.push(others.join(", "));

  let location="";
  for(const p of CATALOG.official_places){ if(new RegExp(`\\b${p.toLowerCase()}\\b`,"i").test(s)){location=`in ${p}`;break;} }
  if(!location){ for(const p of CATALOG.unofficial_places){ if(new RegExp(`\\b${p}\\b`,"i").test(s)){ location = p==="ghetto"?"in ghetto":`near the ${p}`;break;} } }

  let subject=`a ${typ}${num}`;
  if(feats.length){ const last=feats.pop(); subject+= " with " + (feats.length? feats.join(", ")+", ":"") + last; }
  if(location) subject+=` ${location}`;
  return sentenceCase(subject);
}

function buildSentence(opener, subject, moneyLabel, amount){
  let end="."; if(/[\d)]$/.test(subject)) end="";
  const ml=(moneyLabel==="None"?"":`${moneyLabel}: `);
  const money=(moneyLabel==="None"?"":(amount||"Negotiable"));
  return `${opener} ${subject}${moneyLabel==="None"?"":". "+ml+money}${end}`.trim();
}

function generate(){
  clearBadges();
  let raw=rawEl.value.trim();
  if(!raw){ outEl.textContent=""; status("Type a raw ad."); return; }

  if(chkAuto.checked) raw=applyLocalRules(raw);

  let norm=fixTypos(raw);
  norm=applyContainerMaps(norm);
  norm=levelToQuality(norm);

  const catGuess=detectCategory(norm);
  const blk=detectBlacklistOrNonSellable(norm,catGuess);
  if(blk.reject){
    outEl.textContent=`⚠️ Rejected: ${blk.reason}`;
    badge("Rejected","bad"); return;
  }

  let opener = mfOpener.value==="auto"?detectOpener(norm):mfOpener.value;
  let category = catGuess;

  // money
  let moneyLabel = mfMoney.value==="auto"? moneyLabelForOpener(opener): mfMoney.value;
  let amount = mfAmount.value.trim();
  if(!amount){
    let mRaw=extractMoneyRaw(norm);
    // bulk each fix: seeds, wires, etc.
    if(/\b(each)\b/i.test(norm)&&!/\beach\b/i.test(mRaw)) mRaw=(mRaw+" each").trim();
    amount=asMoney(mRaw||"Negotiable");
    if(category==="Business") amount=clampBusinessPrice(amount);
  }else{
    amount=asMoney(amount);
    if(category==="Business") amount=clampBusinessPrice(amount);
  }

  // subject
  let subject=mfSubject.value.trim();

  // replace “i want ATM budget …” style
  norm=norm.replace(/\bi want\s+atm\b/i,"buying atm");

  if(!subject){
    let base=norm;
    base=base.replace(/\b(price|budget|rent|salary)\s*[:.]?\s*\$?\d+(?:\.\d+)?\s*[km]?(\s*each)?/ig,"");
    base=base.replace(/\bprice|budget|rent|salary\s*[:.]?\s*negotiable\b/ig,"");
    base=base.replace(/\bfor sale\b/ig,"");

    if(category==="Business"){
      subject=normalizeBusinessSubject(base) || "a private business";
    }else if(category==="Real Estate"){
      const r=normalizeRealEstate(base);
      if(typeof r==="object" && r.reject){ outEl.textContent=`⚠️ Rejected: ${r.reason}`; badge("Rejected","bad"); return; }
      subject=r;
    }else if(category==="Auto"){
      subject=normalizeAutoSubject(base);
    }else if(category==="Work"){
      subject=normalizeWorkSubject(base,opener);
    }else if(category==="Dating"){
      subject=normalizeDating(base);
    }else{
      subject=normalizeOtherSubject(base);
    }

    // explicit mappings
    subject=subject
      .replace(/\bbuy(?:ing)? a lion\b/i,"Buying cage with a Lion Cub")
      .replace(/\brp ticket\b/i,"Grand ticket");
    if(/buying cage with a lion cub/i.test(subject)) opener="Buying";
  }

  // tuning parts sentence (if present)
  const tparts=parseQuantizedTunings(norm);
  if(tparts.length && category==="Other"){
    subject = `Selling ${tparts.join(", ").replace(/,([^,]*)$/," and$1")}`;
  }

  // business price clamp already done
  if(opener==="Trading"||opener==="Selling or trading") moneyLabel="None";
  if(category==="Discounts"||category==="Services"){ moneyLabel="None"; amount=""; }

  // explicit rejections from your list
  if(/\bbuying\s+p1\b/i.test(norm)) { outEl.textContent="⚠️ Rejected: Cannot buy this vehicle (non sellable)."; badge("Rejected","bad"); return; }
  if(/\bbuy grand coin\b/i.test(norm)) { outEl.textContent="⚠️ Rejected: Grand coins cannot be advertised."; badge("Rejected","bad"); return; }
  if(/\billegal|cocain|cocaine\b/i.test(norm)) { outEl.textContent="⚠️ Rejected: Illegal item."; badge("Rejected","bad"); return; }

  // “hiring family members” normalization to Dating
  if(/hiring family members/i.test(norm)){ opener="Looking for"; category="Dating"; subject="family members"; }

  // auto transform: “i need a girlfriend” → Looking for a girlfriend.
  if(/i need a (girlfriend|boyfriend)/i.test(norm)){ opener="Looking for"; category="Dating"; subject=`a ${RegExp.$1}`; moneyLabel="None"; }

  // party normalization
  if(/party at house\s*(?:no|№)?\s*(\d+)/i.test(norm)){ opener="Party at house №"+RegExp.$1; moneyLabel="None"; category="Other"; subject=""; }

  const sentence = subject
    ? buildSentence(opener, subject, moneyLabel, amount)
    : (category==="Other" ? "Improper ad." : "Improper ad.");

  outEl.textContent=sentence;
  badge(`Detected: ${category}`);
  badge(`Action: ${opener}`);
  if(moneyLabel!=="None") badge(`Money: ${moneyLabel}`);
  if(/Million/.test(amount)||/\.\d{3}\b/.test(amount)) badge("k/m fixed","ok");
  status("Generated.");
}

btnGen.addEventListener("click",generate);
btnClear.addEventListener("click",()=>{rawEl.value="";outEl.textContent="";clearBadges();status("Cleared.")});
btnCopy.addEventListener("click",()=>copyText(outEl.textContent||""));
btnApply.addEventListener("click",()=>{generate();status("Applied.")});
btnApplySave.addEventListener("click",()=>{
  const r=rawEl.value.trim(); if(!r){status("Nothing to save.");return;}
  const rules=getRules();
  const pattern=r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").slice(0,200);
  const replacement=fixTypos(applyContainerMaps(levelToQuality(r)));
  rules.unshift({pattern,replacement});
  setRules(rules);
  status("Saved a rule & applied."); generate();
});
$("#autoRules").addEventListener("change",showRulesInfo);
showRulesInfo(); loadCatalog();
</script>
</body>
</html>
